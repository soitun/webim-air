(function(t,x,aa){function ba(d){return z.call(d)==="[object Function]"}function Y(d){return z.call(d)==="[object Array]"}function ca(d){return d&&z.call(d)==="[object Object]"}function P(d){return(d||"").replace(/^\s+|\s+$/g,"")}function R(d,g){var h=false;if(ca(g)){d=d||{};for(var j in g){var k=g[j];if(d[j]!=k){h=h||{};h[j]=k}}}return h}function ha(d){var g=[];if(d!=null){var h=d.length;if(h==null||typeof d==="string"||ba(d)||d.setInterval)g[0]=d;else for(;h;)g[--h]=d[h]}return g}function L(){var d=
arguments[0]||{},g=1,h=arguments.length,j=false,k;if(typeof d==="boolean"){j=d;d=arguments[1]||{};g=2}if(typeof d!=="object"&&!ba(d))d={};for(;g<h;g++)if((k=arguments[g])!=null)for(var o in k){var w=d[o],C=k[o];if(d!==C)if(j&&C&&typeof C==="object"&&!C.nodeType)d[o]=L(j,w||(C.length!=null?[]:{}),C);else if(C!==aa)d[o]=C}return d}function I(d,g,h){var j,k=0,o=d.length,w=o===aa||ba(d);if(h)if(w)for(j in d){if(g.apply(d[j],h)===false)break}else for(;k<o;){if(g.apply(d[k++],h)===false)break}else if(w)for(j in d){if(g.call(d[j],
j,d[j])===false)break}else for(h=d[0];k<o&&g.call(h,k,h)!==false;h=d[++k]);return d}function E(d,g){for(var h=[],j,k=0,o=d.length;k<o;k++){j=g(d[k],k);if(j!=null)h[h.length]=j}return h.concat.apply([],h)}function s(d){this.type=d;this.timeStamp=(new Date).getTime()}function G(d){this.URL=d;this._setting();this._connect()}function ia(d,g,h){if(typeof g!="undefined"){h=h||{};if(g===null){g="";h.expires=-1}var j="";if(h.expires&&(typeof h.expires=="number"||h.expires.toUTCString)){if(typeof h.expires==
"number"){j=new Date;j.setTime(j.getTime()+h.expires*24*60*60*1E3)}else j=h.expires;j="; expires="+j.toUTCString()}var k=h.path?"; path="+h.path:"",o=h.domain?"; domain="+h.domain:"";h=h.secure?"; secure":"";x.cookie=[d,"=",encodeURIComponent(g),j,k,o,h].join("")}else{g=null;if(x.cookie&&x.cookie!=""){h=x.cookie.split(";");for(j=0;j<h.length;j++){k=P(h[j]);if(k.substring(0,d.length+1)==d+"="){g=decodeURIComponent(k.substring(d.length+1));break}}}return g}}function S(d,g){this.options=L({},S.defaults,
g);this._init(d,g)}function ka(d){return d&&d.split?d.split(","):Y(d)?d:parseInt(d)?[parseInt(d)]:[]}function T(d,g,h){function j(k,o){this.data=k;this.options=L({},j.defaults,o);ba(this._init)&&this._init()}j.defaults=g;s.on(j);L(j.prototype,h);S[d]=j}function u(d,g){if(typeof d=="string"){d[d]=g;if(g===aa)return u[d]}L(u,d)}var z=Object.prototype.toString;s.on=function(){for(var d,g=s.on.prototype,h=0,j=arguments.length;h<j;h++){d=arguments[h].prototype;d.a=d.addEventListener=g.addEventListener;
d.r=d.removeEventListener=g.removeEventListener;d.d=d.dispatchEvent=g.dispatchEvent}};s.on.prototype={addEventListener:function(d,g){var h=this.__listeners=this.__listeners||{};h[d]=h[d]||[];h[d].push(g);return this},dispatchEvent:function(d,g){var h=this.__listeners=this.__listeners||{};d=d.type?d:new s(d);h=h[d.type];if(Object.prototype.toString.call(g)==="[object Array]")g.unshift(d);else g=[d,g];if(h)for(var j=0,k=h.length;j<k;j++)h[j].apply(this,g);return this},removeEventListener:function(d,
g){var h=this.__listeners=this.__listeners||{};if(h[d])if(g){h=h[d];for(var j=h.length;j--;)h[j]===g&&h.splice(j,1)}else delete h[d];return this}};var O=function(){function d(q){var i={};for(var y in d.settings)i[y]=d.settings[y];if(q)for(y in q)i[y]=q[y];var F,M,V,H=i.type.toUpperCase(),U=k.test(H),W,N,a=t,b;i.url=i.url.replace(D,"");i.context=q&&q.context!=null?q.context:i;if(i.data&&i.processData&&typeof i.data!=="string")i.data=g(i.data,i.traditional);var c=Q.exec(i.url);y=t.location;c=c&&(c[1]&&
c[1]!==y.protocol||c[2]!==y.host);/https?:/i.test(y.protocol)||(c=false);c=i.forceRemote?true:c;if(i.dataType==="jsonp"&&!c)i.dataType="json";if(i.dataType==="jsonp"){if(H==="GET")w.test(i.url)||(i.url+=(C.test(i.url)?"&":"?")+(i.jsonp||"callback")+"=?");else if(!i.data||!w.test(i.data))i.data=(i.data?i.data+"&":"")+(i.jsonp||"callback")+"=?";i.dataType="json"}if(i.dataType==="json"&&(i.data&&w.test(i.data)||w.test(i.url))){F=i.jsonpCallback||"jsonp"+h++;if(i.data)i.data=(i.data+"").replace(w,"="+
F+"$1");i.url=i.url.replace(w,"="+F+"$1");i.dataType="script";var e=t[F],f=false;t[F]=function(Z){if(!f){f=true;if(Object.prototype.toString.call(e)==="[object Function]")e(Z);else{t[F]=aa;try{delete t[F]}catch(ga){}}V=Z;A.handleSuccess(i,p,M,V);A.handleComplete(i,p,M,V);W&&W.removeChild(b);N&&N.parentNode&&N.parentNode.removeChild(N)}}}if(i.dataType==="script"&&i.cache===null)i.cache=false;if(i.cache===false&&H==="GET"){var l=(new Date).getTime(),m=i.url.replace(K,"$1_="+l);i.url=m+(m===i.url?(C.test(i.url)?
"&":"?")+"_="+l:"")}if(i.data&&H==="GET")i.url+=(C.test(i.url)?"&":"?")+i.data;i.global&&A.active++;if(i.dataType==="script"&&H==="GET"&&c){q=false;if(F&&i.async&&!j)if(t._fragmentProxy)W=N=x.createDocumentFragment();else{q=true;if(i.url.slice(0,1)=="/")i.url=y.protocol+"//"+y.host+(y.port?":"+y.port:"")+i.url;else if(!/^https?:\/\//i.test(i.url)){y=y.href;H=/([^?#]+)\//.exec(y);i.url=(H?H[1]:y)+"/"+i.url}i.url=i.url.replace("="+F,"=parent."+F);N=x.createElement("iframe");N.style.position="absolute";
N.style.left="-100px";N.style.top="-100px";N.style.height="1px";N.style.width="1px";N.style.visibility="hidden";x.body.insertBefore(N,x.body.firstChild);a=N.contentWindow}var n=function(){var Z=a.document;W=W||Z.getElementsByTagName("head")[0]||Z.documentElement;b=Z.createElement("script");if(i.scriptCharset)b.charset=i.scriptCharset;b.src=i.url;if(j)b.async=i.async;if(F)b.onload=b.onerror=b.onreadystatechange=function(){if(!f&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){f=
true;A.handleError(i,p,"error","load error");W&&b.parentNode&&W.removeChild(b);N&&N.parentNode&&N.parentNode.removeChild(N)}};else{var ga=false;b.onload=b.onreadystatechange=function(){if(!ga&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){ga=true;A.handleSuccess(i,p,M,V);A.handleComplete(i,p,M,V);b.onload=b.onreadystatechange=null;W&&b.parentNode&&W.removeChild(b)}}}W.insertBefore(b,W.firstChild)};q?setTimeout(function(){n()},0):n();return aa}var r=false,p=i.xhr();
if(p){i.username?p.open(H,i.url,i.async,i.username,i.password):p.open(H,i.url,i.async);try{if(i.data!=null&&!U||q&&q.contentType)p.setRequestHeader("Content-Type",i.contentType);if(i.ifModified){A.lastModified[i.url]&&p.setRequestHeader("If-Modified-Since",A.lastModified[i.url]);A.etag[i.url]&&p.setRequestHeader("If-None-Match",A.etag[i.url])}c||p.setRequestHeader("X-Requested-With","XMLHttpRequest");p.setRequestHeader("Accept",i.dataType&&i.accepts[i.dataType]?i.accepts[i.dataType]+", */*; q=0.01":
i.accepts._default)}catch(v){}if(i.beforeSend&&i.beforeSend.call(i.context,p,i)===false){i.global&&A.active--;p.abort();return false}i.global&&A.triggerGlobal(i,"ajaxSend",[p,i]);var da=p.onreadystatechange=function(Z){if(!p||p.readyState===0||Z==="abort"){r||A.handleComplete(i,p,M,V);r=true;if(p)p.onreadystatechange=A.noop}else if(!r&&p&&(p.readyState===4||Z==="timeout")){r=true;p.onreadystatechange=A.noop;M=Z==="timeout"?"timeout":!A.httpSuccess(p)?"error":i.ifModified&&A.httpNotModified(p,i.url)?
"notmodified":"success";var ga;if(M==="success")try{V=A.httpData(p,i.dataType,i)}catch(ma){M="parsererror";ga=ma}if(M==="success"||M==="notmodified")F||A.handleSuccess(i,p,M,V);else A.handleError(i,p,M,ga);F||A.handleComplete(i,p,M,V);Z==="timeout"&&p.abort();if(i.async)p=null}};try{var X=p.abort;p.abort=function(){p&&X.call&&X.call(p);da("abort")}}catch(ea){}i.async&&i.timeout>0&&setTimeout(function(){p&&!r&&da("timeout")},i.timeout);try{p.send(U||i.data==null?null:i.data)}catch(ja){A.handleError(i,
p,null,ja);A.handleComplete(i,p,M,V)}i.async||da();return p}}function g(q){var i=[];if(typeof q=="object"){for(var y in q)i[i.length]=encodeURIComponent(y)+"="+encodeURIComponent(q[y]);return i.join("&").replace(B,"+")}return q}var h=(new Date).getTime(),j=typeof x.createElement("script").async==="boolean",k=/^(?:GET|HEAD|DELETE)$/,o=/\S/,w=/\=\?(&|$)/,C=/\?/,K=/([?&])_=[^&]*/,Q=/^(\w+:)?\/\/([^\/?#]+)/,B=/%20/g,D=/#.*$/;t._fragmentProxy=false;var $=x.createDocumentFragment(),fa=x.createElement("script");
try{fa.appendChild(x.createTextNode("window._fragmentProxy = true"))}catch(la){fa.text="window._fragmentProxy = true"}$.appendChild(fa);$=fa=null;d.param=g;var A={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(q,i,y,F){q.error&&q.error.call(q.context,i,y,F);q.global&&A.triggerGlobal(q,"ajaxError",[i,q,F])},handleSuccess:function(q,i,y,F){q.success&&q.success.call(q.context,F,y,i);q.global&&A.triggerGlobal(q,"ajaxSuccess",[i,q])},handleComplete:function(q,i,y){q.complete&&
q.complete.call(q.context,i,y);q.global&&A.triggerGlobal(q,"ajaxComplete",[i,q]);q.global&&A.active--},triggerGlobal:function(){},httpSuccess:function(q){try{return!q.status&&location.protocol==="file:"||q.status>=200&&q.status<300||q.status===304||q.status===1223}catch(i){}return false},httpNotModified:function(q,i){var y=q.getResponseHeader("Last-Modified"),F=q.getResponseHeader("Etag");if(y)A.lastModified[i]=y;if(F)A.etag[i]=F;return q.status===304},httpData:function(q,i,y){var F=q.getResponseHeader("content-type")||
"",M=i==="xml"||!i&&F.indexOf("xml")>=0;q=M?q.responseXML:q.responseText;M&&q.documentElement.nodeName==="parsererror"&&A.error("parsererror");if(y&&y.dataFilter)q=y.dataFilter(q,i);if(typeof q==="string")if(i==="json"||!i&&F.indexOf("json")>=0)q=q?t.JSON&&t.JSON.parse?t.JSON.parse(q):(new Function("return "+q))():q;else if(i==="script"||!i&&F.indexOf("javascript")>=0)if(q&&o.test(q)){i=x.getElementsByTagName("head")[0]||x.documentElement;y=x.createElement("script");y.type="text/javascript";try{y.appendChild(x.createTextNode(q))}catch(V){y.text=
q}i.insertBefore(y,i.firstChild);i.removeChild(y)}return q}};d.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new t.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};d.setup=function(q){if(q)for(var i in q)d.settings[i]=q[i]};if(t.ActiveXObject)d.settings.xhr=
function(){if(t.location.protocol!=="file:")try{return new t.XMLHttpRequest}catch(q){}try{return new t.ActiveXObject("Microsoft.XMLHTTP")}catch(i){}};return d}(),J=t.JSON?t.JSON:function(){function d(j){return h[j]||"\\u00"+Math.floor(j.charCodeAt()/16).toString(16)+(j.charCodeAt()%16).toString(16)}function g(j){switch(Object.prototype.toString.call(j)){case "[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var k=[],o=j.length,w=0;w<o;w++)k.push(g(j[w]));return"["+
k.join(",")+"]";case "[object Object]":k=[];for(o in j)(w=g(j[o]))&&k.push(g(o)+":"+w);return"{"+k+"}";case "[object Number]":case "[object Boolean]":return String(j);case false:return"null"}return null}var h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:g,parse:function(j){j=j.toString();if(!j||!j.length)return null;return(new Function("return "+j))()}}}();G.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=G.CLOSED;
this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var d=this;if(d._connecting)return d;d.readyState=G.CONNECTING;d._connecting=true;d._onPolling||t.setTimeout(function(){d._startPolling()},300);return d},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=G.OPEN;this.d("open","success")},_onClose:function(d){this._setting();this.d("close",[d])},_onData:function(d){this.d("message",
[d])},_onError:function(d){this._setting();this.d("error",[d])},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;O({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(d){var g=this;g._onPolling=false;if(g._connecting)if(d){g._pollingTimes==1&&g._onConnect();g._onData(d);g._failTimes=0;g._pollTimer=t.setTimeout(function(){g._startPolling()},200)}else return g._onError("error data")},
_onPollError:function(d){var g=this;g._onPolling=false;if(g._connecting){g._failTimes++;if(g._pollingTimes==1)g._onError("can not connect.");else if(g._failTimes>1)g._onClose(d);else g._pollTimer=t.setTimeout(function(){g._startPolling()},200)}}};G.CONNECTING=0;G.OPEN=1;G.CLOSED=2;s.on(G);s.on(S);L(S.prototype,{_init:function(){this.data={user:{presence:"offline",show:"unavailable"}};this.status=new S.status;this.setting=new S.setting;this.buddy=new S.buddy;this.room=new S.room(null,this.data);this.history=
new S.history(null,this.data);this._initEvents()},_createConnect:function(){var d=this,g=d.data.connection;g=g.server+(/\?/.test(g)?"&":"?")+O.param({ticket:g.ticket,domain:g.domain});d.connection=new G(g);d.connection.a("connect",function(){}).a("message",function(h,j){d.handle(j)}).a("error",function(){d._stop("connect","Connect Error")}).a("close",function(){d._stop("connect","Disconnect")})},setUser:function(d){L(this.data.user,d)},_ready:function(d){var g=this;g._unloadFun=t.onbeforeunload;t.onbeforeunload=
function(){g._deactivate()};g.d("beforeOnline",[d])},_go:function(){var d=this.data,g=this.history,h=this.buddy,j=this.room;g.options.userInfo=d.user;I(d.buddies,function(o,w){g.init("unicast",w.id,w.history)});h.set(d.buddies);I(d.rooms,function(o,w){g.init("multicast",w.id,w.history)});h=this.setting.get("blocked_rooms");var k=d.rooms;Y(h)&&k&&I(h,function(o,w){k[w]&&(k[w].blocked=true)});j.set(k);j.options.ticket=d.connection.ticket;this.d("online",[d]);this._createConnect();if((d=d.new_messages)&&
d.length){I(d,function(o,w){w["new"]=true});this.d("message",[d])}},_stop:function(d,g){t.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.d("offline",[d,g])},_initEvents:function(){function d(k){var o={id:k.from,presence:k.type};if(k.show)o.show=k.show;if(k.nick)o.nick=k.nick;if(k.status)o.status=k.status;return o}var g=this,h=g.history,j=g.buddy;g.a("message",function(k,o){for(var w=[],C=o.length,K=g.data.user.id,Q,B,D,$=
0;$<C;$++){Q=o[$];D=Q.type;B=D=="unicast"?Q.to==K?Q.from:Q.to:Q.to;Q.id=B;if(D=="unicast"&&!Q["new"]){B={id:B,presence:"online"};if(Q.nick)B.nick=Q.nick;w.push(B)}}if(w.length){j.presence(w);j.complete()}h.set(o)});g.a("presence",function(k,o){j.presence(E(o,d))})},handle:function(d){d.messages&&d.messages.length&&this.d("message",[d.messages]);d.presences&&d.presences.length&&this.d("presence",[d.presences]);d.statuses&&d.statuses.length&&this.d("status",[d.statuses])},sendMessage:function(d){d.ticket=
this.data.connection.ticket;this.d("sendMessage",[d]);O({type:"get",dataType:"jsonp",cache:false,url:u("message"),data:d})},sendStatus:function(d){d.ticket=this.data.connection.ticket;this.d("sendStatus",[d]);O({type:"get",dataType:"jsonp",cache:false,url:u("status"),data:d})},sendPresence:function(d){d.ticket=this.data.connection.ticket;this.data.user.show=d.show;this.status.set("s",d.show);this.d("sendPresence",[d]);O({type:"get",dataType:"jsonp",cache:false,url:u("presence"),data:d})},online:function(d){var g=
this;d=L({},d);g._ready(d);O({type:"get",dataType:"jsonp",cache:false,url:u("online"),data:d,success:function(h){if(h)if(h.success){h.user=L(g.data.user,h.user,{presence:"online"});g.data=h;g._go()}else g._stop("online",h.error_msg);else g._stop("online","Not Found")},error:function(){g._stop("online","Not Found")}})},offline:function(){var d=this.data;this.connection.close();this._stop("offline","offline");O({type:"get",dataType:"jsonp",cache:false,url:u("offline"),data:{status:"offline",ticket:d.connection.ticket}})},
_deactivate:function(){var d=this.data;!d||!d.connection||!d.connection.ticket||O({type:"get",dataType:"jsonp",cache:false,url:u("deactivate"),data:{ticket:d.connection.ticket}})}});t.webim=S;L(S,{version:"1.1.0",defaults:{},log:function(){var d=new Date;["[",d.getHours(),":",d.getMinutes(),":",d.getSeconds(),"-",d.getMilliseconds(),"]"].join("");if(t&&t.console)t.console.log.apply(null,arguments);else t&&t.runtime&&t.air&&t.air.Introspector&&t.air.Introspector.Console.log.apply(null,arguments)},
idsArray:ka,now:function(){return(new Date).getTime()},isFunction:ba,isArray:Y,isObject:ca,trim:P,makeArray:ha,extend:L,each:I,inArray:function(d,g){for(var h=0,j=g.length;h<j;h++)if(g[h]===d)return h;return-1},grep:function(d,g,h){for(var j=[],k=0,o=d.length;k<o;k++)!h!==!g(d[k],k)&&j.push(d[k]);return j},map:E,JSON:J,ajax:O,comet:G,model:T,route:u,ClassEvent:s});T("setting",{data:{blocked_rooms:[]}},{_init:function(){this.data=L({},this.options.data,this.data)},get:function(d){return this.data[d]},
set:function(d,g){var h=this,j=d;if(d){if(typeof d=="string"){j={};j[d]=g}var k=h.data,o=R(k,j);if(o){I(o,function(w,C){h.d("update",[w,C])});j=L({},k,j);h.data=j;O({type:"get",url:u("setting"),dataType:"jsonp",cache:false,data:{data:J.stringify(j)}})}}}});T("status",{key:"_webim"},{_init:function(){var d=this.data,g=this.options.key;if(d)this._save(d);else this.data=(d=t.localStorage?t.localStorage.getItem(g):ia(g))?J.parse(d):{}},set:function(d,g){var h=d;if(typeof d=="string"){h={};h[d]=g}var j=
this.data;R(j,h)&&this._save(L({},j,h))},get:function(d){return this.data[d]},clear:function(){this._save({})},_save:function(d){var g=this.options.key;this.data=d;d=J.stringify(d);t.localStorage?t.localStorage.setItem(g,d):ia(g,d,{path:"/",domain:x.domain})}});T("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var g=this.dataHash,h=0,j;for(var k in g)if(ca(d)){j=true;for(var o in d)if(d[o]!=
g[k][o])j=false;j&&h++}else h++;return h},get:function(d){return this.dataHash[d]},complete:function(){var d=this.dataHash,g=[],h;for(var j in d){h=d[j];if(h.incomplete&&h.presence=="online"){h.incomplete=false;g.push(j)}}this.load(g)},update:function(d){this.load(d)},presence:function(d){var g=this.dataHash;d=Y(d)?d:[d];for(var h in d){var j=d[h];j.presence=j.presence=="offline"?"offline":"online";j.incomplete=!g[j.id]}this.set(d)},load:function(d){d=ka(d);d.length&&O({type:"get",url:u("buddies"),
cache:false,dataType:"jsonp",data:{ids:d.join(",")},context:this,success:this.set})},set:function(d){var g=this.data,h=this.dataHash,j={};d=d||[];var k,o;for(var w in d){k=d[w];if(id=k.id){if(!h[id]){k.presence=k.presence||"online";k.show=k.show?k.show:k.presence=="offline"?"unavailable":"available";h[id]={};g.push(h[id])}k.incomplete=!!k.incomplete;if(o=R(h[id],k)){k=o.presence||"update";j[k]=j[k]||[];L(h[id],o);j[k].push(h[id])}}}for(var C in j)this.d(C,[j[C]]);this.options.active&&this.complete()}});
(function(){T("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(d){return this.dataHash[d]},block:function(d){var g=this.dataHash[d];if(g&&!g.blocked){g.blocked=true;var h=[];I(this.dataHash,function(j,k){k.blocked&&h.push(k.id)});this.d("block",[d,h])}},unblock:function(d){var g=this.dataHash[d];if(g&&g.blocked){g.blocked=false;var h=[];I(this.dataHash,function(j,k){k.blocked&&h.push(k.id)});this.d("unblock",[d,h])}},set:function(d){var g=this,h=g.data,j=g.dataHash;
I(d,function(k,o){var w=o.id;if(w){o.members=o.members||[];o.count=o.count||0;o.all_count=o.all_count||0;if(j[w])L(j[w],o);else{j[w]=o;h.push(o)}g.d("join",[j[w]])}})},addMember:function(d,g){var h=this;if(Y(g))I(g,function(C,K){h.addMember(d,K)});else{var j=h.dataHash[d];if(j){for(var k=j.members,o,w=k.length;w--;)if(k[w].id==g.id)o=k[w];if(!o){g.nick=g.nick;k.push(g);j.count=k.length;h.d("addMember",[d,g])}}}},removeMember:function(d,g){var h=this.dataHash[d];if(h){for(var j=h.members,k,o=j.length;o--;)if(j[o].id==
g){k=j[o];j.splice(o,1);h.count--}k&&self.d("removeMember",[d,k])}},initMember:function(d){var g=this.dataHash[d];if(g&&!g.initMember){g.initMember=true;this.loadMember(d)}},loadMember:function(d){var g=this,h=g.options;O({type:"get",cache:false,url:u("members"),dataType:"jsonp",data:{ticket:h.ticket,id:d},success:function(j){g.addMember(d,j)}})},join:function(d){var g=this,h=g.options,j=h.user;O({type:"get",cache:false,url:u("join"),dataType:"jsonp",data:{ticket:h.ticket,id:d,nick:j.nick},success:function(k){g.initMember(d);
g.set([k])}})},leave:function(d){var g=this.options,h=this.dataHash[d],j=g.user;if(h){h.initMember=false;O({type:"get",cache:false,url:u("leave"),dataType:"jsonp",data:{ticket:g.ticket,id:d,nick:j.nick}});this.d("leave",[h])}},clear:function(){}})})();T("history",{},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(d,g){return this.data[d][g]},set:function(d){var g=this.data,h={unicast:{},multicast:{}};d=ha(d);
var j=d.length,k,o,w=this.options.userInfo.id;if(j){for(var C=0;C<j;C++){k=d[C];K=k.type;if((o=K=="unicast"?k.to==w?k.from:k.to:k.to)&&K){h[K][o]=h[K][o]||[];h[K][o].push(k)}}for(var K in h)for(o in h[K]){k=h[K][o];if(g[K][o]){g[K][o]=g[K][o].concat(k);this._triggerMsg(K,o,k)}else this.load(K,o)}}},_triggerMsg:function(d,g,h){this.d(d,[g,h])},clear:function(d,g){this.data[d][g]=[];this.d("clear",[d,g]);O({url:u("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:d,id:g}})},download:function(d,
g){var h=u("download"),j=j();j=x.createElement("iframe");var k=new Date,o=[];k={id:g,type:d,time:(new Date).getTime(),date:k.getFullYear()+"-"+(k.getMonth()+1)+"-"+k.getDate()};for(var w in k)o[o.length]=encodeURIComponent(w)+"="+encodeURIComponent(k[w]);h+=(/\?/.test(h)?"&":"?")+o.join("&");j.setAttribute("src",h);j.style.display="none";x.body.appendChild(j)},init:function(d,g,h){if(Y(h)){this.data[d][g]=h;this._triggerMsg(d,g,h)}},load:function(d,g){var h=this;h.data[d][g]=[];O({url:u("history"),
cache:false,type:"get",dataType:"jsonp",data:{type:d,id:g},success:function(j){h.init(d,g,j)}})}})})(window,document);
(function(t,x,aa){function ba(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Y(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ca(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==1&&a!=b&&c.push(a);return c}function P(a,b){if(a)a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)||(a.className+=" "+b)}
function R(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ha(a,b,c){s(a,"mouseover",function(){P(this,b);c&&R(this,c)});s(a,"mouseout",function(){R(this,b);c&&P(this,c)})}function L(a,b,c){if(typeof c==="boolean")c?P(a,b):R(a,b);else a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)?R(a,b):P(a,b)}function I(a){a&&a.style&&(a.style.display="block")}function E(a){a&&a.style&&(a.style.display="none")}function s(a,b,c){if(a.addEventListener)a.addEventListener(b,
c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](t.event)};a.attachEvent("on"+b,a[b+c])}}function G(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function ia(a){if(!a.target)a.target=a.srcElement||x;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function S(){if(!A){A=true;if(q){for(var a,b=0;a=q[b++];)a();q=null}}}function ka(){if(!i){i=true;if(x.readyState==="complete")return S();if(x.addEventListener)x.addEventListener("DOMContentLoaded",
function(){x.removeEventListener("DOMContentLoaded",arguments.callee,false);S()},false);else if(x.attachEvent){x.attachEvent("onreadystatechange",function(){if(x.readyState==="complete"){x.detachEvent("onreadystatechange",arguments.callee);S()}});x.documentElement.doScroll&&t==t.top&&function(){if(!A){try{x.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}S()}}()}s(t,"load",S)}}function T(a){var b=new Date;b.setTime(a?parseFloat(a)+T.timeSkew:(new Date).getTime());this.date=
b}function u(a,b,c){c=B({locale:u.locale},c);c=u.dictionary[c.locale];C(c)||(c={});a=c[a]===aa?a:c[a];if(b){M=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,V)}return a}function z(a,b){this.element=a;this.options=B({},z.defaults,b);this._init()}function O(a){a=a.getElementsByTagName("*");for(var b,c,e={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function J(a){var b=x.createElement("div");b.innerHTML=a;return b=b.firstChild}function d(a,b,c){function e(f,
l){this.id=W++;this.name=a;this.className="webim-"+a;this.options=B({},e.defaults,l);if(this.element=f||this.template&&J(this.template())||this.options.template&&J(H(this.options.template))){this.options.className&&P(this.element,this.options.className);this.$=O(this.element)}o(this._init)&&this._init();o(this._initEvents)&&this._initEvents()}e.defaults=b;fa.on(e);B(e.prototype,d.prototype,c);z[a]=e}function g(a,b){z.apps[a]=b}function h(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+
b:a}function j(){x.selection&&(this.caretPos=x.selection.createRange())}var k=webim.idsArray,o=webim.isFunction,w=webim.isArray,C=webim.isObject,K=webim.trim,Q=webim.makeArray,B=webim.extend,D=webim.each,$=webim.grep,fa=webim.ClassEvent,la=webim.map,A=false,q=[],i=false;T.timeSkew=0;T.init=function(a){T.timeSkew=(new Date).getTime()-parseFloat(a)};B(T.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;
if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return u("dt:today");else if(a<864E5)return u("dt:yesterday")}return u("dt:monthdate",{month:u(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var y=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=
false},init:function(c){B(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';
try{x.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(c)?c:b[c];if(a)try{x.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(e){}}}}(),F=function(){var a=false;s(t,"focus",function(){a=false});s(t,"blur",function(){a=true});var b=x.title,c=0,e=false;return function(f,l){if(a){if(m){clearInterval(m);c=0;e=false}var m=setInterval(function(){c++;e=!e;if(c==l||!a){clearInterval(m);
c=0;e=false}x.title=e?"["+f+"]"+b:b},1500)}}}(),M={},V=function(a,b){return M[b]||""};u.locale="zh-CN";u.dictionary={};u.store=function(a,b){var c=u.dictionary;C(c[a])||(c[a]={});B(c[a],b)};fa.on(z);B(z.prototype,{init:function(){var a=this,b=a.im,c=b.history,e=b.setting,f=a.layout,l=b.room;b.buddy.a("online",function(m,n){f.updateChat("buddy",n)}).a("offline",function(m,n){f.updateChat("buddy",n)}).a("update",function(m,n){f.updateChat("buddy",n)});l.a("addMember",function(m,n,r){(m=f.chat("room",
n))&&m.addMember&&m.addMember(r.id,r.nick,r.id==b.data.user.id)}).a("removeMember",function(m,n,r){(m=f.chat("room",n))&&m.removeMember&&m.removeMember(r.id,r.nick)});b.a("message",function(m,n){for(var r=false,p=n.length,v,da=b.data.user.id,X,ea,ja=0;ja<p;ja++){v=n[ja];X=v.id;type=v.type;(ea=f.chat(type,X))&&ea.status("");if(!ea){v.type==="unicast"?a.addChat(type,X,v.nick):a.addChat(type,X);ea=f.chat(type,X)}ea&&e.get("msg_auto_pop")&&!f.activeTabId&&f.focusChat(X);ea.window.notifyUser("information",
"+1");X=ea.window.pos;X==-1&&f.setNextMsgNum("+1");X==1&&f.setPrevMsgNum("+1");if(v.from!=da)r=true}if(r){a.d("newMessage");y.play("msg");F(u("new message"),5)}});b.a("status",function(m,n){D(n,function(r,p){var v=b.data.user.id,da=p.from;if(!(v!=p.to&&v!=p.from))(v=f.chat("buddy",da))&&v.status(p.show)})});c.a("unicast",function(m,n,r){(m=f.chat("unicast",n))&&m.history.add(r)});c.a("multicast",function(m,n,r){(m=f.chat("multicast",n))&&m.history.add(r)});c.a("clear",function(m,n,r){(m=f.chat(n,
r))&&m.history.clear()})},render:function(){this.layout.render()},addApp:function(a,b){var c=z.apps[a];if(c)return this[a]=c.apply(this,[b])},addChat:function(a,b,c){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var e=this.layout,f=this.im.buddy,l=this.im.room;if(!e.chat(a,b)){if(a=="room")l=l.get(b);else(l=f.get(b))||f.update(b);e.addChat(a,b,this.addApp("chat",{type:a,user:this.im.data.user,info:l||{id:b,nick:c||b}}))}},_init:function(){this.im=new webim(null,this.options.imOptions);this.addApp("layout",
this.options.layoutOptions);this._initEvents();o(this.init)&&this.init()},_initEvents:function(){this.im.a("online",function(a,b){T.init(b.server_time)})}});var H=function(){function a(e,f){return b&&b[f]!=aa?b[f]:u(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,f){if(!e)return"";b=f;return e.replace(c,a)}}(),U={add:function(a,b,c){a=z[a].prototype;for(var e in c){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=
0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},W=1;B(d.prototype,{_init:function(){}});B(z,{version:"3.0.1",widget:d,app:g,plugin:U,i18n:u,date:T,ready:function(a){ka();A?a():q.push(a)},createElement:J,defaults:{},apps:{}});webim.ui=z;d("window",{main:false,visible:true,maximizable:true,minimizable:true,closeable:true,closeToHide:false,layout:"app:/test/air.window.html",template:'<div class="webim"><div id=":webim-window" class="webim-window ui-widget">                                            <div id=":window" class="webim-window-window webim-box">                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                    \t<a id=":resize" title="<%=resize%>" class="webim-window-resize" href="#resize"><em class="ui-icon ui-icon-grip-diagonal-se"><%=resize%></em></a>                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize ui-state-default ui-corner-all" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize ui-state-default ui-corner-all" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close ui-state-default ui-corner-all" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content webim-box webim-flex">                                                    </div>                                            </div>                                            </div></div>'},
{_init:function(a,b){var c=this;b=c.options;var e=c.$;a=c.element;b.name&&P(a,"webim-"+b.name+"-window");if(t.runtime)if(b.main){c.window=t;c.__initEvents()}else{var f=air.Screen.mainScreen.visibleBounds;f=new air.Rectangle((f.width-480)/2,(f.height-480)/2,480,480);var l=new air.NativeWindowInitOptions;l.transparent=true;l.systemChrome=air.NativeWindowSystemChrome.NONE;var m=air.HTMLLoader.createRootWindow(true,l,false,f);m.navigateInSystemBrowser=true;m.stage.nativeWindow.title=b.title;m.load(new air.URLRequest(c.options.layout));
var n=false;s(m,air.Event.COMPLETE,function(){if(!n){n=true;c.window=m.window;c.__initEvents();m.window.document.body.appendChild(a)}})}else{P(a,"webim-browser");b.main||x.body.appendChild(a);c.__initEvents()}b.subHeader&&c.header(b.subHeader);c.title(b.title);!b.minimizable&&E(e.minimize);!b.maximizable&&E(e.maximize);!b.closeable&&E(e.close);!b.resizable&&E(e.resize)},__initEvents:function(){var a=this,b=a.$,c=function(f){if(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=true}G(f)};D(ca(b.actions.firstChild),
function(f,l){ha(l,"ui-state-hover")});D(["minimize","maximize","close","resize"],function(f,l){s(b[l],"click",function(m){this.disabled||a[l]();c(m)});s(b[l],"mousedown",c)});if(t.runtime){var e=a.window.nativeWindow;s(a.window.document,"keydown",function(){});s(b.headerTitle,"dblclick",function(){a._os.mac?a.minimize():a.maximize()});s(b.header,"mousedown",function(){if(a.isMaximized())return false;e.startMove()});s(b.resize,"mousedown",function(){e.startResize(air.NativeWindowResize.BOTTOM_RIGHT)});
s(e,air.NativeWindowBoundsEvent.RESIZE,function(f){a.d("resize",f)});s(e,air.NativeWindowBoundsEvent.MOVE,function(f){a.d("move",f)});s(e,air.Event.ACTIVATE,function(f){a.d("activate",f)});s(e,air.Event.DEACTIVATE,function(f){a.d("deactivate",f)});s(e,air.Event.CLOSING,function(f){if(a.options.closeToHide){a.hide();f.preventDefault()}});s(e,air.Event.CLOSE,function(f){a.d("close",f)});s(e,air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGE,function(f){a.d("displayStateChange",f)})}},content:function(a){a?
this.$.content.appendChild(a):this.$.content.innerHTML=""},header:function(a){a?this.$.subHeader.appendChild(a):this.$.subHeader.innerHTML=""},title:function(a){this.$.headerTitle.innerHTML=a;this.options.title=a;this.window&&(this.window.nativeWindow.title=a)},icon:function(){this.options.title=title},notifyUser:function(a){air.NativeWindow.supportsNotification&&this.window&&this.window.notifyUser(a)},show:function(){this.window&&(this.window.nativeWindow.visible=true)},hide:function(){this.window&&
(this.window.nativeWindow.visible=false)},_changeState:function(a){var b=this.element;a="webim-window-"+(a=="restore"?"normal":a);b&&(b.className=b.className.replace(RegExp("(^|\\s+)("+"webim-window-normal webim-window-maximize webim-window-minimize".split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+a)},maximize:function(){if(this.isMaximized())this.restore();else{this.window&&this.window.nativeWindow&&this.window.nativeWindow.maximize();this._changeState("maximize")}},restore:function(){this.window&&
this.window.nativeWindow&&this.window.nativeWindow.restore();this._changeState("restore")},minimize:function(){if(!this.isMinimized()){this.window&&this.window.nativeWindow&&this.window.nativeWindow.minimize();this._changeState("minimize")}},close:function(){if(this.options.closeToHide)this.hide();else this.window&&this.window.nativeWindow&&this.window.nativeWindow.close()},activate:function(){var a=this.window&&this.window.nativeWindow;a&&a.activate()},isActive:function(){return this.window&&this.window.nativeWindow.active},
isMaximized:function(){return this.window&&this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MAXIMIZED},isMinimized:function(){return this.window&&this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MINIMIZED},_os:function(){var a=t.runtime&&air.Capabilities.os;return{mac:/Mac/i.test(a),win:/Windows/i.test(a),linux:/Linux/i.test(a)}}()});g("layout",function(a){a=a||{};var b=this.im;layoutUI=new z.layout(a.layout,a.layoutOptions);this.addApp("login",B({container:layoutUI.element},
a.loginOptions));this.addApp("user",B({container:layoutUI.window.$.subHeader},a.userOptions));b.a("online",function(){layoutUI.showContent()});layoutUI.window.header(layoutUI.tabs.element);return layoutUI});d("layout",{template:'<div id=":layout" class="webim-layout webim-flex webim-box">\t\t<div id=":widgets" class="webim-widgets webim-flex webim-box webim-hide"></div>\t\t<div id=":shortcut" class="webim-shortcut ui-widget-header webim-hide"></div>\t</div>'},{_init:function(a,b){var c=this;b=c.options;
B(c,{window:new z.window(null,{main:true,closeToHide:true,name:"layout",title:"webim",maximizable:true,icon:""}),widgets:{},chats:{},tabs:new z.tabs(null,{panel:c.$.widgets}),chatWindows:{}});P(c.tabs.element,"webim-hide");c.window.content(c.element);if(t.runtime){var e=false,f=air.NativeApplication,l=f.nativeApplication,m=l.icon,n,r=(new DOMParser).parseFromString(l.applicationDescriptor,"text/xml"),p=function(){c.window.show()};s(l,air.Event.EXITING,function(){c.window.options.closeToHide=false});
if(f.supportsSystemTrayIcon){e=true;n=r.getElementsByTagName("image16x16")[0].textContent;s(m,"click",p);m.tooltip=c.window.options.title}else if(f.supportsDockIcon){e=true;n=r.getElementsByTagName("image128x128")[0].textContent;s(l,air.InvokeEvent.INVOKE,p);c._badge=t.runtime.de&&t.runtime.de.mattesgroeger.air.icon.AirIconBadge}if(e){e=new air.Loader;s(e.contentLoaderInfo,air.Event.COMPLETE,function(v){v=v.target.content.bitmapData;m.bitmaps=new runtime.Array(v);try{c._badge&&(c._badge.customIcon=
new runtime.flash.display.Bitmap(v))}catch(da){}});e.load(new air.URLRequest("app:/"+n));if(!f.supportsDockIcon){f=new air.NativeMenu;n=new air.NativeMenuItem(u("logout"));s(n,air.Event.SELECT,function(){l.exit()});f.addItem(n);m.menu=f}}}},_initEvents:function(){},render:function(){x.body.appendChild(this.window.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=b.container,e=B(b,{main:false,closeable:false,subHeader:a.header}),f=a.element;this.widgets[a.name]=a;a.widget_title=
b.title;if(c=="window"){c=new z.window(null,e);c.content(f);a.container=c}else if(c=="tab"){this.tabs.add(a.element,b.title,b.icon);this.tabs.select(b.title)}},showWidget:function(a){this.tabs.select(this.widgets[a].widget_title)},focusChat:function(a,b){b=h(a,b);var c=this.chatWindows[b],e=this.chats[b];c&&c.activate();e&&e.focus()},chat:function(a,b){return this.chats[h(a,b)]},updateChat:function(a,b){b=Q(b);for(var c,e=b.length,f,l=0;l<e;l++){c=b[l];(f=this.chats[h(a,c.id)])&&f.update(c)}},updateAllChat:function(){D(this.chats,
function(a,b){b.update()})},addChat:function(a,b,c){var e=this,f=e.chats;b=h(a,b);if(!f[b]){a=e.chatWindows[b]=(new z.window(null,{main:false,name:"chat",title:"webim",maximizable:true,icon:""})).a("close",function(){delete e.chatWindows[b];delete e.chats[b]});c.setWindow(a);f[b]=c}},removeChat:function(a,b){var c=this.chatWindows[h(a,b)];c&&c.close()},removeAllChat:function(){D(this.chatWindows,function(a,b){b.close()})},showContent:function(){R(this.$.widgets,"webim-hide");R(this.tabs.element,"webim-hide");
R(this.$.shortcut,"webim-hide")},setBadge:function(a){try{this._badge.label=a.toString()}catch(b){}},notifyUser:function(a){t.runtime&&air.NativeApplication.supportsDockIcon&&air.NativeApplication.nativeApplication.icon.bounce(a)}});d("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){U.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML=
"";this.d("clear")},add:function(a){a=Q(a);var b=a.length,c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.d("update")}},_renderMsg:function(a){a=B({},a);U.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,f=a.body,l=true,m=this._lastLogItem,n=[],r;r=a.nick;if(m&&m.to==c&&m.from==b&&e-m.timestamp<6E4)l=false;if(l){this._lastLogItem=a;a=new T(e);n.push('<h4><span class="webim-gray">');n.push(a.getDay(true));n.push(" ");
n.push(a.getTime());n.push("</span>");n.push(r);n.push('</h4><hr class="webim-line ui-state-default" />')}n.push("<p>");n.push(f);n.push("</p>");return n.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,f=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){f.push("<h5>");f.push((new T(a)).getDay(true));f.push("</h5>")}return f.join("")},ui:function(a){return B({element:this.element,$:this.$},a)},plugins:{}});var N=
function(){function a(e,f){return'<a href="'+(f=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>"}function b(e,f){c+=" "+e+'="'+f+'"'}var c;return function(e,f){c="";f&&C(f)&&D(f,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();z.history.defaults.parseMsg=true;U.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=ba(c);c=N(c,{target:"_blank"});b.msg.body=c}});z.history.defaults.emot=true;U.add("history","emot",{render:function(a,b){b.msg.body=z.emot.parse(b.msg.body)}});d("emot",
{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;D(b.firstChild.childNodes,function(c,e){s(e,"click",function(){R(b,"webim-emot-show");a.d("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');D(a,function(c,e){var f=e.src,l=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(l);b.push('" alt="');b.push(e.q[0]);
b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return H(this.options.template,{emots:b.join("")})},toggle:function(){L(this.element,"webim-emot-show")}});B(z.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},
{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=B({dir:"webim/static/emot/default"},
a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";D(b.emots,function(f,l){if(l&&l.src)l.src=e+l.src;l&&l.q&&D(l.q,function(m,n){c[n]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&D(b,function(e,f){var l=c[f],m=l.src,n=l.t?l.t:l.q[0],r=[];r.push('<img src="');r.push(m);r.push('" title="');r.push(n);r.push('" alt="');r.push(l.q[0]);r.push('" />');e=ba(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),r.join(""))});
return a}});g("chat",function(a){a=a||{};var b=this.im,c=b.buddy,e=b.room,f=b.history,l=a.info,m=l.id;if(a.type=="room"){l.presence="online";var n=f.get("multicast",m);n||f.load("multicast",m);B(a,{history:n,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"});var r=new z.chat(null,a);r.a("sendMsg",function(p,v){b.sendMsg(v);f.handle(v)}).a("downloadHistory",function(p,v){f.download("multicast",v.id)}).a("select",function(p,v){v.presence="online";c.presence(v);self.addChat("buddy",
v.id,v.nick);layout.focusChat("buddy",v.id)}).a("block",function(p,v){e.block(v.id)}).a("unblock",function(p,v){e.unblock(v.id)}).a("destroy",function(){r.options.info.blocked&&e.leave(m)});setTimeout(function(){r.options.info.blocked?e.join(m):e.initMember(m)},500);w(l.members)&&D(l.members,function(p,v){r.addMember(v.id,v.nick,v.id==b.data.user.id)})}else{(n=f.get("unicast",m))||f.load("unicast",m);B(a,{history:n,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"});r=new z.chat(null,
a);r.a("sendMsg",function(p,v){b.sendMsg(v);f.handle(v)}).a("sendStatus",function(p,v){b.sendStatus(v)}).a("clearHistory",function(p,v){f.clear("unicast",v.id)}).a("downloadHistory",function(p,v){f.download("unicast",v.id)})}return r});d("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat webim-box webim-flex"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content webim-flex">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.options,b=a.window,c=this.history=new z.history(null,{user:a.user,info:a.info});this.$.content.insertBefore(c.element,this.$.content.firstChild);this.header=J(H(a.tpl_header));B(this.$,O(this.header));b&&this.setWindow(b);a.simple&&E(this.header);this.update(a.info);c.add(a.history);U.call(this,"init",[null,this.ui()]);this._adjustContent()},setWindow:function(a){this.window=a;a.header(this.header);a.content(this.element);a.title(this.options.info.nick);this._bindWindow()},
update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(u("buddy offline notice",{name:this.options.info.nick}));else this.notice(u("user offline notice"));U.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;t.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,e=c.$.notice,f=c._noticeTime;
f&&clearTimeout(f);if(a)if(b){e.innerHTML=a;I(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=c._noticeTxt;else E(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;I(e)}else{c._noticeTxt=null;E(e)}},_adjustContent:function(){var a=this.$.content;if(a.scrollHeight-a.scrollTop-a.clientHeight<200)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.a("displayStateChange",function(b,c){if(c!="minimize"){t.setTimeout(function(){a.$.input.focus()},
0);a._adjustContent()}}).a("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},_sendMsg:function(a){var b=this.options,c=b.info;a={type:b.msgType,to:c.id,from:b.user.id,nick:b.user.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};U.call(this,"send",[null,this.ui({msg:a})]);this.d("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=
ia(a),c=b.value;if(K(c).length){this._sendMsg(c);b.value="";G(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ia(a);(t.getSelection?t.getSelection().toString():x.selection?x.selection.createRange().text:"")||t.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=u("input notice"),e=b.input;a.history.a("update",function(){a._adjustContent()}).a("clear",function(){a.notice(u("clear history notice"),3E3)});s(e,"keyup",function(){j.call(this)});s(e,"click",
j);s(e,"select",j);s(e,"focus",function(){R(this,"webim-gray");if(this.value==c)this.value=""});s(e,"blur",function(){if(this.value==""){P(this,"webim-gray");this.value=c}});s(e,"keypress",function(f){a._inputkeypress(f)});s(b.content,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",
a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=Y(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,f=c.selectionStart,l=c.selectionEnd,m=e.substring(0,f);e=e.substring(l);l=a.length;c.value=m+a+e;c.setSelectionRange(f+l,f+l)}else if(x.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||
a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.d("sendStatus",{to:this.options.info.id,show:a})}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=t.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":c+u(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!=
"")this._setST=t.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.d("destroy")},ui:function(a){return B({self:this,$:this.$,history:this.history},a)},plugins:{}});z.chat.defaults.emot=true;U.add("chat","emot",{init:function(a,b){var c=b.self,e=new z.emot;e.a("select",function(l,m){c.focus();c.insert(m,true)});var f=J(H('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));s(f,"click",function(l){G(l);e.toggle()});b.$.toolContent.appendChild(e.element);
b.$.tools.appendChild(f)},send:function(){}});z.chat.defaults.clearHistory=true;U.add("chat","clearHistory",{init:function(a,b){var c=b.self,e=J(H('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));s(e,"click",function(f){G(f);c.d("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});z.chat.defaults.block=true;U.add("chat","block",{init:function(a,b){var c=b.self,e=c.options.info.blocked,f=c.options.info.nick,l=J('<a href="#chat-block" style="display:'+
(e?"none":"")+'" title="'+u("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),m=J('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+u("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');s(l,"click",function(n){G(n);E(l);I(m);c.d("block",[c.options.info])});s(m,"click",function(n){G(n);E(m);I(l);c.d("unblock",[c.options.info])});b.$.tools.appendChild(l);b.$.tools.appendChild(m)}});z.chat.defaults.member=true;B(z.chat.prototype,
{addMember:function(a,b,c){var e=this,f=e.memberLi;if(!f[a]){var l=J('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");s(l.firstChild,"click",function(m){G(m);c||e.d("select",[{id:a,nick:b}])});f[a]=l;e.$.member.appendChild(l);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});
U.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=J(H('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),f=O(e);c.member=f.ul;c.memberCount=f.memberCount;c.content.parentNode.insertBefore(e,c.content)}});z.chat.defaults.downloadHistory=true;U.add("chat","downloadHistory",{init:function(a,
b){var c=b.self,e=J(H('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));s(e,"click",function(f){G(f);c.d("downloadHistory",[c.options.info])});b.$.tools.appendChild(e)}});g("setting",{init:function(a){var b=this.im.setting,c=this.layout,e=this.setting=new z.setting(null,a);c.addWidget(e,{title:u("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,l){typeof l!="object"&&
e.check_tag(f,l)});e.bind("change",function(f,l){b.set(f,l)})},stop:function(){}});d("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],c=a.options.data;c&&D(c,function(e,f){f&&typeof f!="boolean"||b.push(a._check_tpl(e,
f))});return H(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&D(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return H(this.options.tpl_check,{label:u(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;s(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(C(a))D(a,function(l,m){c.check_tag(l,m)});else{var e=c.$,f=e[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=
b;else{f=e[a]=J(c._check_tpl(a,b));c._check_event(f);e.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});g("user",function(a){a=a||{};var b=this.im,c=new z.user;E(c.element);a.container&&a.container.appendChild(c.element);c.a("online",function(e,f){b.online(f)}).a("offline",function(){b.offline()}).a("presence",function(e,f){b.sendPresence(f)});c.update(b.data.user);b.a("online",function(){I(c.element);c.update(b.data.user)}).a("offline",function(){c.show("unavailable")});
return c});d("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;s(b.userShowTrigger,"click",function(e){c.style.display=="block"?E(c):I(c);G(e)});D(ca(c.firstChild),function(e,f){s(f,"click",function(l){a._set(this.href.split("#")[1]);E(c);G(l)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=Y(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?
a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=u(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.d("offline",[]);else b.show=="unavailable"?this.d("online",[{show:a}]):this.d("presence",[{show:a,status:b.status}])}else a!="unavailable"&&
this.d("online",[{show:a}])},destroy:function(){}});g("login",function(a){a=a||{};var b=this.im,c=new z.login(null,a);a.container&&a.container.appendChild(c.element);c.a("login",function(e,f){b.online(f)});b.a("online",function(){c.hide()}).a("offline",function(e,f,l){f=="online"&&c.showError(l)});return c});d("login",{questions:null,notice:"",template:'<div>  \t\t<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?D(a,function(c,e){var f=x.createElement("option");f.value=e[0];f.innerHTML=e[1];b.question.appendChild(f)}):E(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ha(b.submit,"ui-state-hover");s(b.form,"submit",function(c){G(c);a.d("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){E(this.element)},show:function(){I(this.element)},
hideError:function(){E(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=u(a);I(b)},destroy:function(){}});g("buddy",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=b.layout,l=new z.buddy(null,B({title:u("buddy")},a));f.addWidget(l,{container:"tab",title:u("buddy"),icon:"buddy"});l.a("select",function(p,v){b.addChat("buddy",v.id);b.layout.focusChat("buddy",v.id)});var m=function(p){return C(p)?p.id:p},n=function(p){return p.show!="invisible"&&p.presence=="online"},r=function(p){return p.show==
"invisible"};e.a("online",function(p,v){l.add($(v,n))});e.a("offline",function(p,v){l.remove(la(v,m))});e.a("update",function(p,v){l.add($(v,n));l.update($(v,n));l.remove(la($(v,r),m))});l.offline();c.a("beforeOnline",function(){l.online()}).a("online",function(){l.titleCount()}).a("offline",function(){l.offline()});return l});d("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&P(this.element,"webim-buddy-hidegroup");a.simple&&P(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=u("search buddy");s(c.firstChild,"click",function(){e.focus()});e.value=f;s(e,"focus",function(){P(c,"ui-state-active");if(this.value==f)this.value=""});s(e,"blur",function(){R(c,"ui-state-active");if(this.value=="")this.value=f});s(e,"keyup",function(){var l=
this.value;D(a.li,function(m,n){l&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(l)==-1?E(n):I(n)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?E(c):I(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){L(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+u(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");E(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();E(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var c=b.show?b.show:"available";a.className="webim-icon webim-icon-"+c;a.setAttribute("title",
u(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=Y(b.status)||"&nbsp;";return a},_addOne:function(a,b){var c=this,e=c.li,f=a.id,l=c.$.ul;if(!e[f]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=Y(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=u(a.show);a.pic_url=a.pic_url||"";e=e[f]=J(H(c.options.tpl_li,
a));s(e.firstChild,"click",function(r){G(r);c.d("select",[a]);this.blur()});var m=c.groups,n=u(a.group||"friend");m=m[n];if(!m){m=J(H(c.options.tpl_group));E(m);if(n==u("stranger"))b=true;b?l.appendChild(m):l.insertBefore(m,l.firstChild);m={name:n,el:m,count:0,title:m.firstChild,li:m.lastChild};c.groups[n]=m}m.count==0&&I(m.el);c.li_group[f]=m;m.li.appendChild(e);m.count++;m.title.innerHTML=n+"("+m.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=
Q(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=Q(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,f,l=this.li_group;a=k(a);for(var m=0;m<a.length;m++){b=a[m];if(c=e[b]){this.size--;if(f=l[b]){f.count--;f.count==0&&E(f.el);f.title.innerHTML=f.name+"("+f.count+")"}c&&c.parentNode&&c.parentNode.removeChild(c);delete e[b]}}this.titleCount()},
select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});g("room",function(){function a(n){var r=n.nick;n=B({},n,{group:"group",nick:r+"("+(parseInt(n.count)+"/"+parseInt(n.all_count))+")"});l.updateChat(n);n.blocked&&(n.nick=r+"("+u("blocked")+")");m.li[n.id]?m.update(n):m.add(n)}var b=this,c=b.im,e=c.room,f=c.setting,l=b.layout,m=b.room=(new webim.ui.room(null)).a("select",function(n,r){b.addChat("room",r.id);b.layout.focusChat("room",r.id)});l.addWidget(m,{container:"tab",
title:u("room"),icon:"room"});c.setting.a("update",function(){});e.a("join",function(n,r){a(r)}).a("leave",function(){}).a("block",function(n,r,p){f.set("blocked_rooms",p);a(e.get(r));e.leave(r)}).a("unblock",function(n,r,p){f.set("blocked_rooms",p);a(e.get(r));e.join(r)}).a("addMember",function(n,r){a(e.get(r))}).a("removeMember",function(n,r){a(e.get(r))})});d("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;I(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=u("search room");s(c.firstChild,"click",function(){e.focus()});e.value=f;s(e,"focus",function(){P(c,
"ui-state-active");if(this.value==f)this.value=""});s(e,"blur",function(){R(c,"ui-state-active");if(this.value=="")this.value=f});s(e,"keyup",function(){var l=this.value;D(a.li,function(m,n){l&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(l)==-1?E(n):I(n)})})},scroll:function(a){L(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,f=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=J(H(b.options.tpl_li,a));s(c.firstChild,"click",function(l){G(l);b.d("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=Q(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){E(this.$.empty);a=Q(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);
this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=k(a);for(var f=0;f<a.length;f++){b=a[f];if(c=e[b]){c&&c.parentNode&&c.parentNode.removeChild(c);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});g("menu",{init:function(a){var b=this.layout;a=this.menu=new z.menu(null,a);b.addWidget(a,{title:u("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},
null,"shortcut")}});d("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&E(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&D(c,function(e,f){b.push(a._li_tpl(f))});return H(a.options.template,
{list:b.join("")})},_li_tpl:function(a){return H(this.options.tpl_li,{title:u(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(w(a))D(a,function(e,f){b.add(f)});else{var c=b.$;E(c.empty);c.ul.appendChild(J(b._li_tpl(a)))}},destroy:function(){}});d("tabs",{template:'<div class="webim-tabs">\t\t<ul id=":nav" class="webim-tabs-nav ui-helper-clearfix"></ul>\t\t\t</div>',panel:false},
{_init:function(){this.panels={};this.navs={}},add:function(a,b){var c=this.$.nav,e=this.navs[b]=J('<li class="ui-corner-top ui-state-default"><a href="#">'+b+"</a></li>");P(a=a?a.nodeType?a:x.getElementById(a):null,"ui-helper-hidden-accessible");this.panels[b]=a;c.appendChild(e);this.options.panel&&this.options.panel.appendChild(a);this._tabEvent(e,b)},select:function(a){if(a=this.navs[a]){a=ca(a.firstChild)[0];if(x.createEvent){var b=x.createEvent("HTMLEvents");b.initEvent("click",true,true);a.dispatchEvent(b)}a.fireEvent&&
a.fireEvent("onclick")}},_tabEvent:function(a,b){var c=this,e=ca(a.firstChild)[0];s(e,"click",function(f){D(c.panels,function(l,m){P(m,"ui-helper-hidden-accessible")});D(c.navs,function(l,m){R(m,"ui-state-active")});R(c.panels[b],"ui-helper-hidden-accessible");P(c.navs[b],"ui-state-active");G(f)})}})})(window,document);
