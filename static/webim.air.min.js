(function(t,x,$){function aa(d){return z.call(d)==="[object Function]"}function Y(d){return z.call(d)==="[object Array]"}function ba(d){return d&&z.call(d)==="[object Object]"}function N(d){return(d||"").replace(/^\s+|\s+$/g,"")}function R(d,f){var h=false;if(ba(f)){d=d||{};for(var j in f){var l=f[j];if(d[j]!=l){h=h||{};h[j]=l}}}return h}function ia(d){var f=[];if(d!=null){var h=d.length;if(h==null||typeof d==="string"||aa(d)||d.setInterval)f[0]=d;else for(;h;)f[--h]=d[h]}return f}function O(){var d=
arguments[0]||{},f=1,h=arguments.length,j=false,l;if(typeof d==="boolean"){j=d;d=arguments[1]||{};f=2}if(typeof d!=="object"&&!aa(d))d={};for(;f<h;f++)if((l=arguments[f])!=null)for(var n in l){var v=d[n],E=l[n];if(d!==E)if(j&&E&&typeof E==="object"&&!E.nodeType)d[n]=O(j,v||(E.length!=null?[]:{}),E);else if(E!==$)d[n]=E}return d}function K(d,f,h){var j,l=0,n=d.length,v=n===$||aa(d);if(h)if(v)for(j in d){if(f.apply(d[j],h)===false)break}else for(;l<n;){if(f.apply(d[l++],h)===false)break}else if(v)for(j in d){if(f.call(d[j],
j,d[j])===false)break}else for(h=d[0];l<n&&f.call(h,l,h)!==false;h=d[++l]);return d}function G(d,f){for(var h=[],j,l=0,n=d.length;l<n;l++){j=f(d[l],l);if(j!=null)h[h.length]=j}return h.concat.apply([],h)}function s(d){this.type=d;this.timeStamp=(new Date).getTime()}function I(d){this.URL=d;this._setting();this._connect()}function ja(d,f,h){if(typeof f!="undefined"){h=h||{};if(f===null){f="";h.expires=-1}var j="";if(h.expires&&(typeof h.expires=="number"||h.expires.toUTCString)){if(typeof h.expires==
"number"){j=new Date;j.setTime(j.getTime()+h.expires*24*60*60*1E3)}else j=h.expires;j="; expires="+j.toUTCString()}var l=h.path?"; path="+h.path:"",n=h.domain?"; domain="+h.domain:"";h=h.secure?"; secure":"";x.cookie=[d,"=",encodeURIComponent(f),j,l,n,h].join("")}else{f=null;if(x.cookie&&x.cookie!=""){h=x.cookie.split(";");for(j=0;j<h.length;j++){l=N(h[j]);if(l.substring(0,d.length+1)==d+"="){f=decodeURIComponent(l.substring(d.length+1));break}}}return f}}function S(d,f){this.options=O({},S.defaults,
f);this._init(d,f)}function ka(d){return d&&d.split?d.split(","):Y(d)?d:parseInt(d)?[parseInt(d)]:[]}function T(d,f,h){function j(l,n){this.data=l;this.options=O({},j.defaults,n);aa(this._init)&&this._init()}j.defaults=f;s.on(j);O(j.prototype,h);S[d]=j}function u(d,f){if(typeof d=="string"){d[d]=f;if(f===$)return u[d]}O(u,d)}var z=Object.prototype.toString;s.on=function(){for(var d,f=s.on.prototype,h=0,j=arguments.length;h<j;h++){d=arguments[h].prototype;d.a=d.addEventListener=f.addEventListener;
d.r=d.removeEventListener=f.removeEventListener;d.d=d.dispatchEvent=f.dispatchEvent}};s.on.prototype={addEventListener:function(d,f){var h=this.__listeners=this.__listeners||{};h[d]=h[d]||[];h[d].push(f);return this},dispatchEvent:function(d,f){var h=this.__listeners=this.__listeners||{};d=d.type?d:new s(d);h=h[d.type];if(Object.prototype.toString.call(f)==="[object Array]")f.unshift(d);else f=[d,f];if(h)for(var j=0,l=h.length;j<l;j++)h[j].apply(this,f);return this},removeEventListener:function(d,
f){var h=this.__listeners=this.__listeners||{};if(h[d])if(f){h=h[d];for(var j=h.length;j--;)h[j]===f&&h.splice(j,1)}else delete h[d];return this}};var P=function(){function d(q){var i={};for(var y in d.settings)i[y]=d.settings[y];if(q)for(y in q)i[y]=q[y];var H,D,J,X=i.type.toUpperCase(),ca=l.test(X),W,a,b=t,c;i.url=i.url.replace(F,"");i.context=q&&q.context!=null?q.context:i;if(i.data&&i.processData&&typeof i.data!=="string")i.data=f(i.data,i.traditional);var e=Q.exec(i.url);y=t.location;e=e&&(e[1]&&
e[1]!==y.protocol||e[2]!==y.host);/https?:/i.test(y.protocol)||(e=false);e=i.forceRemote?true:e;if(i.dataType==="jsonp"&&!e)i.dataType="json";if(i.dataType==="jsonp"){if(X==="GET")v.test(i.url)||(i.url+=(E.test(i.url)?"&":"?")+(i.jsonp||"callback")+"=?");else if(!i.data||!v.test(i.data))i.data=(i.data?i.data+"&":"")+(i.jsonp||"callback")+"=?";i.dataType="json"}if(i.dataType==="json"&&(i.data&&v.test(i.data)||v.test(i.url))){H=i.jsonpCallback||"jsonp"+h++;if(i.data)i.data=(i.data+"").replace(v,"="+
H+"$1");i.url=i.url.replace(v,"="+H+"$1");i.dataType="script";var g=t[H],k=false;t[H]=function(U){if(!k){k=true;if(Object.prototype.toString.call(g)==="[object Function]")g(U);else{t[H]=$;try{delete t[H]}catch(ga){}}J=U;A.handleSuccess(i,p,D,J);A.handleComplete(i,p,D,J);W&&W.removeChild(c);a&&a.parentNode&&a.parentNode.removeChild(a)}}}if(i.dataType==="script"&&i.cache===null)i.cache=false;if(i.cache===false&&X==="GET"){var o=(new Date).getTime(),m=i.url.replace(M,"$1_="+o);i.url=m+(m===i.url?(E.test(i.url)?
"&":"?")+"_="+o:"")}if(i.data&&X==="GET")i.url+=(E.test(i.url)?"&":"?")+i.data;i.global&&A.active++;if(i.dataType==="script"&&X==="GET"&&e){q=false;if(H&&i.async&&!j)if(t._fragmentProxy)W=a=x.createDocumentFragment();else{q=true;if(i.url.slice(0,1)=="/")i.url=y.protocol+"//"+y.host+(y.port?":"+y.port:"")+i.url;else if(!/^https?:\/\//i.test(i.url)){y=y.href;X=/([^?#]+)\//.exec(y);i.url=(X?X[1]:y)+"/"+i.url}i.url=i.url.replace("="+H,"=parent."+H);a=x.createElement("iframe");a.style.position="absolute";
a.style.left="-100px";a.style.top="-100px";a.style.height="1px";a.style.width="1px";a.style.visibility="hidden";x.body.insertBefore(a,x.body.firstChild);b=a.contentWindow}var r=function(){var U=b.document;W=W||U.getElementsByTagName("head")[0]||U.documentElement;c=U.createElement("script");if(i.scriptCharset)c.charset=i.scriptCharset;c.src=i.url;if(j)c.async=i.async;if(H)c.onload=c.onerror=c.onreadystatechange=function(){if(!k&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){k=
true;A.handleError(i,p,"error","load error");W&&c.parentNode&&W.removeChild(c);a&&a.parentNode&&a.parentNode.removeChild(a)}};else{var ga=false;c.onload=c.onreadystatechange=function(){if(!ga&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){ga=true;A.handleSuccess(i,p,D,J);A.handleComplete(i,p,D,J);c.onload=c.onreadystatechange=null;W&&c.parentNode&&W.removeChild(c)}}}W.insertBefore(c,W.firstChild)};q?setTimeout(function(){r()},0):r();return $}var w=false,p=i.xhr();if(p){i.username?
p.open(X,i.url,i.async,i.username,i.password):p.open(X,i.url,i.async);try{if(i.data!=null&&!ca||q&&q.contentType)p.setRequestHeader("Content-Type",i.contentType);if(i.ifModified){A.lastModified[i.url]&&p.setRequestHeader("If-Modified-Since",A.lastModified[i.url]);A.etag[i.url]&&p.setRequestHeader("If-None-Match",A.etag[i.url])}e||p.setRequestHeader("X-Requested-With","XMLHttpRequest");p.setRequestHeader("Accept",i.dataType&&i.accepts[i.dataType]?i.accepts[i.dataType]+", */*; q=0.01":i.accepts._default)}catch(B){}if(i.beforeSend&&
i.beforeSend.call(i.context,p,i)===false){i.global&&A.active--;p.abort();return false}i.global&&A.triggerGlobal(i,"ajaxSend",[p,i]);var V=p.onreadystatechange=function(U){if(!p||p.readyState===0||U==="abort"){w||A.handleComplete(i,p,D,J);w=true;if(p)p.onreadystatechange=A.noop}else if(!w&&p&&(p.readyState===4||U==="timeout")){w=true;p.onreadystatechange=A.noop;D=U==="timeout"?"timeout":!A.httpSuccess(p)?"error":i.ifModified&&A.httpNotModified(p,i.url)?"notmodified":"success";var ga;if(D==="success")try{J=
A.httpData(p,i.dataType,i)}catch(ma){D="parsererror";ga=ma}if(D==="success"||D==="notmodified")H||A.handleSuccess(i,p,D,J);else A.handleError(i,p,D,ga);H||A.handleComplete(i,p,D,J);U==="timeout"&&p.abort();if(i.async)p=null}};try{var ha=p.abort;p.abort=function(){p&&ha.call&&ha.call(p);V("abort")}}catch(ea){}i.async&&i.timeout>0&&setTimeout(function(){p&&!w&&V("timeout")},i.timeout);try{p.send(ca||i.data==null?null:i.data)}catch(da){A.handleError(i,p,null,da);A.handleComplete(i,p,D,J)}i.async||V();
return p}}function f(q){var i=[];if(typeof q=="object"){for(var y in q)i[i.length]=encodeURIComponent(y)+"="+encodeURIComponent(q[y]);return i.join("&").replace(C,"+")}return q}var h=(new Date).getTime(),j=typeof x.createElement("script").async==="boolean",l=/^(?:GET|HEAD|DELETE)$/,n=/\S/,v=/\=\?(&|$)/,E=/\?/,M=/([?&])_=[^&]*/,Q=/^(\w+:)?\/\/([^\/?#]+)/,C=/%20/g,F=/#.*$/;t._fragmentProxy=false;var Z=x.createDocumentFragment(),fa=x.createElement("script");try{fa.appendChild(x.createTextNode("window._fragmentProxy = true"))}catch(la){fa.text=
"window._fragmentProxy = true"}Z.appendChild(fa);Z=fa=null;d.param=f;var A={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(q,i,y,H){q.error&&q.error.call(q.context,i,y,H);q.global&&A.triggerGlobal(q,"ajaxError",[i,q,H])},handleSuccess:function(q,i,y,H){q.success&&q.success.call(q.context,H,y,i);q.global&&A.triggerGlobal(q,"ajaxSuccess",[i,q])},handleComplete:function(q,i,y){q.complete&&q.complete.call(q.context,i,y);q.global&&A.triggerGlobal(q,"ajaxComplete",[i,q]);q.global&&
A.active--},triggerGlobal:function(){},httpSuccess:function(q){try{return!q.status&&location.protocol==="file:"||q.status>=200&&q.status<300||q.status===304||q.status===1223}catch(i){}return false},httpNotModified:function(q,i){var y=q.getResponseHeader("Last-Modified"),H=q.getResponseHeader("Etag");if(y)A.lastModified[i]=y;if(H)A.etag[i]=H;return q.status===304},httpData:function(q,i,y){var H=q.getResponseHeader("content-type")||"",D=i==="xml"||!i&&H.indexOf("xml")>=0;q=D?q.responseXML:q.responseText;
D&&q.documentElement.nodeName==="parsererror"&&A.error("parsererror");if(y&&y.dataFilter)q=y.dataFilter(q,i);if(typeof q==="string")if(i==="json"||!i&&H.indexOf("json")>=0)q=q?t.JSON&&t.JSON.parse?t.JSON.parse(q):(new Function("return "+q))():q;else if(i==="script"||!i&&H.indexOf("javascript")>=0)if(q&&n.test(q)){i=x.getElementsByTagName("head")[0]||x.documentElement;y=x.createElement("script");y.type="text/javascript";try{y.appendChild(x.createTextNode(q))}catch(J){y.text=q}i.insertBefore(y,i.firstChild);
i.removeChild(y)}return q}};d.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new t.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};d.setup=function(q){if(q)for(var i in q)d.settings[i]=q[i]};if(t.ActiveXObject)d.settings.xhr=function(){if(t.location.protocol!==
"file:")try{return new t.XMLHttpRequest}catch(q){}try{return new t.ActiveXObject("Microsoft.XMLHTTP")}catch(i){}};return d}(),L=t.JSON?t.JSON:function(){function d(j){return h[j]||"\\u00"+Math.floor(j.charCodeAt()/16).toString(16)+(j.charCodeAt()%16).toString(16)}function f(j){switch(Object.prototype.toString.call(j)){case "[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var l=[],n=j.length,v=0;v<n;v++)l.push(f(j[v]));return"["+l.join(",")+"]";case "[object Object]":l=
[];for(n in j)(v=f(j[n]))&&l.push(f(n)+":"+v);return"{"+l+"}";case "[object Number]":case "[object Boolean]":return String(j);case false:return"null"}return null}var h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:f,parse:function(j){j=j.toString();if(!j||!j.length)return null;return(new Function("return "+j))()}}}();I.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=I.CLOSED;this._onPolling=this._connecting=false;
this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var d=this;if(d._connecting)return d;d.readyState=I.CONNECTING;d._connecting=true;d._onPolling||t.setTimeout(function(){d._startPolling()},300);return d},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=I.OPEN;this.d("open","success")},_onClose:function(d){this._setting();this.d("close",[d])},_onData:function(d){this.d("message",[d])},_onError:function(d){this._setting();
this.d("error",[d])},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;P({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(d){var f=this;f._onPolling=false;if(f._connecting)if(d){f._pollingTimes==1&&f._onConnect();f._onData(d);f._failTimes=0;f._pollTimer=t.setTimeout(function(){f._startPolling()},200)}else return f._onError("error data")},_onPollError:function(d){var f=this;
f._onPolling=false;if(f._connecting){f._failTimes++;if(f._pollingTimes==1)f._onError("can not connect.");else if(f._failTimes>1)f._onClose(d);else f._pollTimer=t.setTimeout(function(){f._startPolling()},200)}}};I.CONNECTING=0;I.OPEN=1;I.CLOSED=2;s.on(I);s.on(S);O(S.prototype,{_init:function(){this.data={user:{presence:"offline",show:"unavailable"}};this.status=new S.status;this.setting=new S.setting;this.buddy=new S.buddy;this.room=new S.room(null,this.data);this.history=new S.history(null,this.data);
this._initEvents()},_createConnect:function(){var d=this,f=d.data.connection;f=f.server+(/\?/.test(f)?"&":"?")+P.param({ticket:f.ticket,domain:f.domain});d.connection=new I(f);d.connection.a("connect",function(){}).a("message",function(h,j){d.handle(j)}).a("error",function(){d._stop("connect","Connect Error")}).a("close",function(){d._stop("connect","Disconnect")})},setUser:function(d){O(this.data.user,d)},_ready:function(d){var f=this;f._unloadFun=t.onbeforeunload;t.onbeforeunload=function(){f._deactivate()};
f.d("beforeOnline",[d])},_go:function(){var d=this.data,f=this.history,h=this.buddy,j=this.room;f.options.userInfo=d.user;K(d.buddies,function(n,v){f.init("unicast",v.id,v.history)});h.set(d.buddies);K(d.rooms,function(n,v){f.init("multicast",v.id,v.history)});h=this.setting.get("blocked_rooms");var l=d.rooms;Y(h)&&l&&K(h,function(n,v){l[v]&&(l[v].blocked=true)});j.set(l);j.options.ticket=d.connection.ticket;this.d("online",[d]);this._createConnect();if((d=d.new_messages)&&d.length){K(d,function(n,
v){v["new"]=true});this.d("message",[d])}},_stop:function(d,f){t.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.d("offline",[d,f])},_initEvents:function(){function d(l){var n={id:l.from,presence:l.type};if(l.show)n.show=l.show;if(l.nick)n.nick=l.nick;if(l.status)n.status=l.status;return n}var f=this,h=f.history,j=f.buddy;f.a("message",function(l,n){for(var v=[],E=n.length,M=f.data.user.id,Q,C,F,Z=0;Z<E;Z++){Q=n[Z];F=Q.type;
C=F=="unicast"?Q.to==M?Q.from:Q.to:Q.to;Q.id=C;if(F=="unicast"&&!Q["new"]){C={id:C,presence:"online"};if(Q.nick)C.nick=Q.nick;v.push(C)}}if(v.length){j.presence(v);j.complete()}h.set(n)});f.a("presence",function(l,n){j.presence(G(n,d))})},handle:function(d){d.messages&&d.messages.length&&this.d("message",[d.messages]);d.presences&&d.presences.length&&this.d("presence",[d.presences]);d.statuses&&d.statuses.length&&this.d("status",[d.statuses])},sendMessage:function(d){d.ticket=this.data.connection.ticket;
this.d("sendMessage",[d]);P({type:"get",dataType:"jsonp",cache:false,url:u("message"),data:d})},sendStatus:function(d){d.ticket=this.data.connection.ticket;this.d("sendStatus",[d]);P({type:"get",dataType:"jsonp",cache:false,url:u("status"),data:d})},sendPresence:function(d){d.ticket=this.data.connection.ticket;this.data.user.show=d.show;this.status.set("s",d.show);this.d("sendPresence",[d]);P({type:"get",dataType:"jsonp",cache:false,url:u("presence"),data:d})},online:function(d){var f=this;d=O({},
d);f._ready(d);P({type:"get",dataType:"jsonp",cache:false,url:u("online"),data:d,success:function(h){if(h)if(h.success){h.user=O(f.data.user,h.user,{presence:"online"});f.data=h;f._go()}else f._stop("online",h.error_msg);else f._stop("online","Not Found")},error:function(){f._stop("online","Not Found")}})},offline:function(){var d=this.data;this.connection.close();this._stop("offline","offline");P({type:"get",dataType:"jsonp",cache:false,url:u("offline"),data:{status:"offline",ticket:d.connection.ticket}})},
_deactivate:function(){var d=this.data;!d||!d.connection||!d.connection.ticket||P({type:"get",dataType:"jsonp",cache:false,url:u("deactivate"),data:{ticket:d.connection.ticket}})}});t.webim=S;O(S,{version:"1.1.0",defaults:{},log:function(){var d=new Date;["[",d.getHours(),":",d.getMinutes(),":",d.getSeconds(),"-",d.getMilliseconds(),"]"].join("");if(t&&t.console)t.console.log.apply(null,arguments);else t&&t.runtime&&t.air&&t.air.Introspector&&t.air.Introspector.Console.log.apply(null,arguments)},
idsArray:ka,now:function(){return(new Date).getTime()},isFunction:aa,isArray:Y,isObject:ba,trim:N,makeArray:ia,extend:O,each:K,inArray:function(d,f){for(var h=0,j=f.length;h<j;h++)if(f[h]===d)return h;return-1},grep:function(d,f,h){for(var j=[],l=0,n=d.length;l<n;l++)!h!==!f(d[l],l)&&j.push(d[l]);return j},map:G,JSON:L,ajax:P,comet:I,model:T,route:u,ClassEvent:s});T("setting",{data:{blocked_rooms:[]}},{_init:function(){this.data=O({},this.options.data,this.data)},get:function(d){return this.data[d]},
set:function(d,f){var h=this,j=d;if(d){if(typeof d=="string"){j={};j[d]=f}var l=h.data,n=R(l,j);if(n){K(n,function(v,E){h.d("update",[v,E])});j=O({},l,j);h.data=j;P({type:"get",url:u("setting"),dataType:"jsonp",cache:false,data:{data:L.stringify(j)}})}}}});T("status",{key:"_webim"},{_init:function(){var d=this.data,f=this.options.key;if(d)this._save(d);else this.data=(d=t.localStorage?t.localStorage.getItem(f):ja(f))?L.parse(d):{}},set:function(d,f){var h=d;if(typeof d=="string"){h={};h[d]=f}var j=
this.data;R(j,h)&&this._save(O({},j,h))},get:function(d){return this.data[d]},clear:function(){this._save({})},_save:function(d){var f=this.options.key;this.data=d;d=L.stringify(d);t.localStorage?t.localStorage.setItem(f,d):ja(f,d,{path:"/",domain:x.domain})}});T("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var f=this.dataHash,h=0,j;for(var l in f)if(ba(d)){j=true;for(var n in d)if(d[n]!=
f[l][n])j=false;j&&h++}else h++;return h},get:function(d){return this.dataHash[d]},complete:function(){var d=this.dataHash,f=[],h;for(var j in d){h=d[j];if(h.incomplete&&h.presence=="online"){h.incomplete=false;f.push(j)}}this.load(f)},update:function(d){this.load(d)},presence:function(d){var f=this.dataHash;d=Y(d)?d:[d];for(var h in d){var j=d[h];j.presence=j.presence=="offline"?"offline":"online";j.incomplete=!f[j.id]}this.set(d)},load:function(d){d=ka(d);d.length&&P({type:"get",url:u("buddies"),
cache:false,dataType:"jsonp",data:{ids:d.join(",")},context:this,success:this.set})},set:function(d){var f=this.data,h=this.dataHash,j={};d=d||[];var l,n;for(var v in d){l=d[v];if(id=l.id){if(!h[id]){l.presence=l.presence||"online";l.show=l.show?l.show:l.presence=="offline"?"unavailable":"available";h[id]={};f.push(h[id])}l.incomplete=!!l.incomplete;if(n=R(h[id],l)){l=n.presence||"update";j[l]=j[l]||[];O(h[id],n);j[l].push(h[id])}}}for(var E in j)this.d(E,[j[E]]);this.options.active&&this.complete()}});
(function(){T("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(d){return this.dataHash[d]},block:function(d){var f=this.dataHash[d];if(f&&!f.blocked){f.blocked=true;var h=[];K(this.dataHash,function(j,l){l.blocked&&h.push(l.id)});this.d("block",[d,h])}},unblock:function(d){var f=this.dataHash[d];if(f&&f.blocked){f.blocked=false;var h=[];K(this.dataHash,function(j,l){l.blocked&&h.push(l.id)});this.d("unblock",[d,h])}},set:function(d){var f=this,h=f.data,j=f.dataHash;
K(d,function(l,n){var v=n.id;if(v){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(j[v])O(j[v],n);else{j[v]=n;h.push(n)}f.d("join",[j[v]])}})},addMember:function(d,f){var h=this;if(Y(f))K(f,function(E,M){h.addMember(d,M)});else{var j=h.dataHash[d];if(j){for(var l=j.members,n,v=l.length;v--;)if(l[v].id==f.id)n=l[v];if(!n){f.nick=f.nick;l.push(f);j.count=l.length;h.d("addMember",[d,f])}}}},removeMember:function(d,f){var h=this.dataHash[d];if(h){for(var j=h.members,l,n=j.length;n--;)if(j[n].id==
f){l=j[n];j.splice(n,1);h.count--}l&&self.d("removeMember",[d,l])}},initMember:function(d){var f=this.dataHash[d];if(f&&!f.initMember){f.initMember=true;this.loadMember(d)}},loadMember:function(d){var f=this,h=f.options;P({type:"get",cache:false,url:u("members"),dataType:"jsonp",data:{ticket:h.ticket,id:d},success:function(j){f.addMember(d,j)}})},join:function(d){var f=this,h=f.options,j=h.user;P({type:"get",cache:false,url:u("join"),dataType:"jsonp",data:{ticket:h.ticket,id:d,nick:j.nick},success:function(l){f.initMember(d);
f.set([l])}})},leave:function(d){var f=this.options,h=this.dataHash[d],j=f.user;if(h){h.initMember=false;P({type:"get",cache:false,url:u("leave"),dataType:"jsonp",data:{ticket:f.ticket,id:d,nick:j.nick}});this.d("leave",[h])}},clear:function(){}})})();T("history",{},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(d,f){return this.data[d][f]},set:function(d){var f=this.data,h={unicast:{},multicast:{}};d=ia(d);
var j=d.length,l,n,v=this.options.userInfo.id;if(j){for(var E=0;E<j;E++){l=d[E];M=l.type;if((n=M=="unicast"?l.to==v?l.from:l.to:l.to)&&M){h[M][n]=h[M][n]||[];h[M][n].push(l)}}for(var M in h)for(n in h[M]){l=h[M][n];if(f[M][n]){f[M][n]=f[M][n].concat(l);this._triggerMsg(M,n,l)}else this.load(M,n)}}},_triggerMsg:function(d,f,h){this.d(d,[f,h])},clear:function(d,f){this.data[d][f]=[];this.d("clear",[d,f]);P({url:u("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:d,id:f}})},download:function(d,
f){var h=u("download"),j=j();j=x.createElement("iframe");var l=new Date,n=[];l={id:f,type:d,time:(new Date).getTime(),date:l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()};for(var v in l)n[n.length]=encodeURIComponent(v)+"="+encodeURIComponent(l[v]);h+=(/\?/.test(h)?"&":"?")+n.join("&");j.setAttribute("src",h);j.style.display="none";x.body.appendChild(j)},init:function(d,f,h){if(Y(h)){this.data[d][f]=h;this._triggerMsg(d,f,h)}},load:function(d,f){var h=this;h.data[d][f]=[];P({url:u("history"),
cache:false,type:"get",dataType:"jsonp",data:{type:d,id:f},success:function(j){h.init(d,f,j)}})}})})(window,document);
(function(t,x,$){function aa(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Y(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ba(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==1&&a!=b&&c.push(a);return c}function N(a,b){if(a)a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)||(a.className+=" "+b)}function R(a,
b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ia(a,b,c){s(a,"mouseover",function(){N(this,b);c&&R(this,c)});s(a,"mouseout",function(){R(this,b);c&&N(this,c)})}function O(a,b,c){if(typeof c==="boolean")c?N(a,b):R(a,b);else a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)?R(a,b):N(a,b)}function K(a){a&&a.style&&(a.style.display="block")}function G(a){a&&a.style&&(a.style.display="none")}function s(a,b,c){if(a.addEventListener)a.addEventListener(b,
c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](t.event)};a.attachEvent("on"+b,a[b+c])}}function I(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function ja(a){if(!a.target)a.target=a.srcElement||x;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function S(){if(!A){A=true;if(q){for(var a,b=0;a=q[b++];)a();q=null}}}function ka(){if(!i){i=true;if(x.readyState==="complete")return S();if(x.addEventListener)x.addEventListener("DOMContentLoaded",
function(){x.removeEventListener("DOMContentLoaded",arguments.callee,false);S()},false);else if(x.attachEvent){x.attachEvent("onreadystatechange",function(){if(x.readyState==="complete"){x.detachEvent("onreadystatechange",arguments.callee);S()}});x.documentElement.doScroll&&t==t.top&&function(){if(!A){try{x.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}S()}}()}s(t,"load",S)}}function T(a){var b=new Date;b.setTime(a?parseFloat(a)+T.timeSkew:(new Date).getTime());this.date=
b}function u(a,b,c){c=C({locale:u.locale},c);c=u.dictionary[c.locale];E(c)||(c={});a=c[a]===$?a:c[a];if(b){y=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,H)}return a}function z(a,b){this.element=a;this.options=C({},z.defaults,b);this._init()}function P(a){a=a.getElementsByTagName("*");for(var b,c,e={},g=a.length-1;g>-1;g--){b=a[g];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function L(a){var b=x.createElement("div");b.innerHTML=a;return b=b.firstChild}function d(a,b,c){function e(g,
k){this.id=X++;this.name=a;this.className="webim-"+a;this.options=C({},e.defaults,k);if(this.element=g||this.template&&L(this.template())||this.options.template&&L(D(this.options.template))){this.options.className&&N(this.element,this.options.className);this.$=P(this.element)}n(this._init)&&this._init();n(this._initEvents)&&this._initEvents()}e.defaults=b;fa.on(e);C(e.prototype,d.prototype,c);z[a]=e}function f(a,b){z.apps[a]=b}function h(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+
b:a}function j(){x.selection&&(this.caretPos=x.selection.createRange())}var l=webim.idsArray,n=webim.isFunction,v=webim.isArray,E=webim.isObject,M=webim.trim,Q=webim.makeArray,C=webim.extend,F=webim.each,Z=webim.grep,fa=webim.ClassEvent,la=webim.map,A=false,q=[],i=false;T.timeSkew=0;T.init=function(a){T.timeSkew=(new Date).getTime()-parseFloat(a)};C(T.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;
if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return u("dt:today");else if(a<864E5)return u("dt:yesterday")}return u("dt:monthdate",{month:u(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});(function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=
false},init:function(c){C(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';
try{x.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(c)?c:b[c];if(a)try{x.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(e){}}}})();(function(){var a=false;s(t,"focus",function(){a=false});s(t,"blur",function(){a=true});var b=x.title,c=0,e=false;return function(g,k){if(a){if(o){clearInterval(o);c=0;e=false}var o=setInterval(function(){c++;e=!e;if(c==k||!a){clearInterval(o);
c=0;e=false}x.title=e?"["+g+"]"+b:b},1500)}}})();var y={},H=function(a,b){return y[b]||""};u.locale="zh-CN";u.dictionary={};u.store=function(a,b){var c=u.dictionary;E(c[a])||(c[a]={});C(c[a],b)};fa.on(z);C(z.prototype,{init:function(){},render:function(){this.layout.render()},addApp:function(a,b){var c=z.apps[a];if(c)return this[a]=c.apply(this,[b])},addChat:function(a,b,c){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var e=this.layout,g=this.im.buddy,k=this.im.room;if(!e.chat(a,b)){if(a=="room")k=
k.get(b);else(k=g.get(b))||g.update(b);e.addChat(a,b,this.addApp("chat",{type:a,user:this.im.data.user,info:k||{id:b,nick:c||b}}))}},_init:function(){this.im=new webim(null,this.options.imOptions);this.addApp("layout",this.options.layoutOptions);this._initEvents();n(this.init)&&this.init()},_initEvents:function(){this.im.a("online",function(a,b){T.init(b.server_time)})}});var D=function(){function a(e,g){return b&&b[g]!=$?b[g]:u(g)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,g){if(!e)return"";
b=g;return e.replace(c,a)}}(),J={add:function(a,b,c){a=z[a].prototype;for(var e in c){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},X=1;C(d.prototype,{_init:function(){}});C(z,{version:"3.0.1",widget:d,app:f,plugin:J,i18n:u,date:T,ready:function(a){ka();A?a():q.push(a)},createElement:L,defaults:{},apps:{}});webim.ui=z;d("window",{main:false,visible:true,
maximizable:true,minimizable:true,closeable:true,resizable:true,closeToHide:false,layout:"app:/test/air.window.html",template:'<div class="webim"><div id=":webim-window" class="webim-window ui-widget">                                            <div id=":window" class="webim-window-window webim-box">                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                    \t<a id=":resize" title="<%=resize%>" class="webim-window-resize" href="#resize"><em class="ui-icon ui-icon-grip-diagonal-se"><%=resize%></em></a>                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize ui-state-default ui-corner-all" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize ui-state-default ui-corner-all" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close ui-state-default ui-corner-all" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content webim-box webim-flex">                                                    </div>                                            </div>                                            </div></div>'},
{_init:function(a,b){var c=this;b=c.options;var e=c.$;a=c.element;b.name&&N(a,"webim-"+b.name+"-window");if(t.runtime)if(b.main){c.window=t;c.__initEvents()}else{var g=air.Screen.mainScreen.visibleBounds;g=new air.Rectangle((g.width-480)/2,(g.height-480)/2,480,480);var k=new air.NativeWindowInitOptions;k.transparent=true;k.systemChrome=air.NativeWindowSystemChrome.NONE;var o=air.HTMLLoader.createRootWindow(true,k,false,g);o.navigateInSystemBrowser=true;o.stage.nativeWindow.title=b.title;o.load(new air.URLRequest(c.options.layout));
var m=false;s(o,air.Event.COMPLETE,function(){if(!m){m=true;c.window=o.window;c.__initEvents();o.window.document.body.appendChild(a)}})}else{N(a,"webim-browser");b.main||x.body.appendChild(a);c.__initEvents()}b.subHeader&&c.header(b.subHeader);!b.minimizable&&G(e.minimize);!b.maximizable&&G(e.maximize);!b.closeable&&G(e.close);!b.resizable&&G(e.resize)},__initEvents:function(){var a=this,b=a.$;a.title(a.options.title);var c=function(g){if(g){g.stopPropagation&&g.stopPropagation();g.cancelBubble=true}I(g)};
F(ba(b.actions.firstChild),function(g,k){ia(k,"ui-state-hover")});F(["minimize","maximize","close","resize"],function(g,k){s(b[k],"click",function(o){this.disabled||a[k]();c(o)});s(b[k],"mousedown",c)});if(t.runtime){var e=a.window.nativeWindow;s(a.window.document,"keydown",function(){});s(b.headerTitle,"dblclick",function(){ca=="mac"?a.minimize():a.maximize()});s(b.header,"mousedown",function(){if(a.isMaximized())return false;e.startMove()});s(b.resize,"mousedown",function(){e.startResize(air.NativeWindowResize.BOTTOM_RIGHT)});
s(e,air.NativeWindowBoundsEvent.RESIZE,function(g){a.d("resize",g)});s(e,air.NativeWindowBoundsEvent.MOVE,function(g){a.d("move",g)});s(e,air.Event.ACTIVATE,function(g){a.d("activate",g)});s(e,air.Event.DEACTIVATE,function(g){a.d("deactivate",g)});s(e,air.Event.CLOSING,function(g){if(a.options.closeToHide){a.hide();g.preventDefault()}});s(e,air.Event.CLOSE,function(g){a.d("close",g)});s(e,air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGE,function(g){var k="webim-window-"+g.afterDisplayState;
el&&(el.className=el.className.replace(RegExp("(^|\\s+)("+"webim-window-normal webim-window-maximized webim-window-minimized".split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+k);a.d("displayStateChange",g)})}},content:function(a){a?this.$.content.appendChild(a):this.$.content.innerHTML=""},header:function(a){a?this.$.subHeader.appendChild(a):this.$.subHeader.innerHTML=""},title:function(a){this.$.headerTitle.innerHTML=a;this.options.title=a;this.window&&(this.window.nativeWindow.title=a)},icon:function(){this.options.title=
title},notifyUser:function(a){t.runtime&&air.NativeWindow.supportsNotification&&this.window&&this.window.notifyUser(a)},show:function(){this.window&&(this.window.nativeWindow.visible=true)},hide:function(){this.window&&(this.window.nativeWindow.visible=false)},maximize:function(){if(this.isMaximized())this.restore();else this.window&&this.window.nativeWindow&&this.window.nativeWindow.maximize()},restore:function(){this.window&&this.window.nativeWindow&&this.window.nativeWindow.restore()},minimize:function(){this.isMinimized()||
this.window&&this.window.nativeWindow&&this.window.nativeWindow.minimize()},close:function(){if(this.options.closeToHide)this.hide();else this.window&&this.window.nativeWindow&&this.window.nativeWindow.close()},activate:function(){var a=this.window&&this.window.nativeWindow;a&&a.activate()},isActive:function(){return this.window&&this.window.nativeWindow.active},isMaximized:function(){return this.window&&this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MAXIMIZED},isMinimized:function(){return this.window&&
this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MINIMIZED}});var ca=t.runtime&&air.Capabilities.os;ca=/Mac/i.test(ca)?"mac":/Windows/i.test(ca)?"win":/Linux/i.test(ca)?"linux":"unknown";f("layout",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,g=c.history,k=c.setting,o=c.room,m=new z.layout(a.layout,a.layoutOptions);b.addApp("login",C({container:m.element},a.loginOptions));b.addApp("user",C({container:m.window.$.subHeader},a.userOptions));e.a("online",function(r,w){m.updateChat("buddy",
w)}).a("offline",function(r,w){m.updateChat("buddy",w)}).a("update",function(r,w){m.updateChat("buddy",w)});o.a("addMember",function(r,w,p){(r=m.chat("room",w))&&r.addMember&&r.addMember(p.id,p.nick,p.id==c.data.user.id)}).a("removeMember",function(r,w,p){(r=m.chat("room",w))&&r.removeMember&&r.removeMember(p.id,p.nick)});c.a("online",function(){m.showContent()}).a("message",function(r,w){for(var p=0,B=w.length,V,ha=c.data.user.id,ea,da,U=0;U<B;U++){V=w[U];ea=V.id;type=V.type;(da=m.chat(type,ea))&&
da.status("");if(!da){V.type==="unicast"?b.addChat(type,ea,V.nick):b.addChat(type,ea);da=m.chat(type,ea)}da&&k.get("msg_auto_pop")&&!m.activeTabId&&m.focusChat(ea);da.window.notifyUser("informational");V.from!=ha&&p++}p&&m.notifyUser("informational")}).a("status",function(r,w){F(w,function(p,B){var V=c.data.user.id,ha=B.from;if(!(V!=B.to&&V!=B.from))(V=m.chat("buddy",ha))&&V.status(B.show)})});g.a("unicast",function(r,w,p){(r=m.chat("unicast",w))&&r.history.add(p)}).a("multicast",function(r,w,p){(r=
m.chat("multicast",w))&&r.history.add(p)}).a("clear",function(r,w,p){(r=m.chat(w,p))&&r.history.clear()});m.window.header(m.tabs.element);return m});d("layout",{template:'<div id=":layout" class="webim-layout webim-flex webim-box">\t\t<div id=":widgets" class="webim-widgets webim-flex webim-box webim-hide"></div>\t\t\t<div id=":shortcut" class="webim-shortcut ui-widget-header webim-hide"></div>\t\t\t\t</div>'},{_init:function(){C(this,{window:new z.window(null,{main:true,closeToHide:true,name:"layout",
title:"webim",maximizable:true,icon:""}),widgets:{},chats:{},tabs:new z.tabs(null,{panel:this.$.widgets}),chatWindows:{}});N(this.tabs.element,"webim-hide");this.window.content(this.element);this._initDesktop()},_initDesktop:function(){var a=this;if(t.runtime){var b=false,c=air.NativeApplication,e=c.nativeApplication,g=e.icon,k,o=(new DOMParser).parseFromString(e.applicationDescriptor,"text/xml"),m=function(){a.window.show()};s(e,air.Event.EXITING,function(){a.window.options.closeToHide=false});if(c.supportsSystemTrayIcon){b=
true;k=o.getElementsByTagName("image16x16")[0].textContent;s(g,"click",m);g.tooltip=a.window.options.title}else if(c.supportsDockIcon){b=true;k=o.getElementsByTagName("image128x128")[0].textContent;s(e,air.InvokeEvent.INVOKE,m);a._badge=t.runtime.de&&t.runtime.de.mattesgroeger.air.icon.AirIconBadge}if(b){b=new air.Loader;s(b.contentLoaderInfo,air.Event.COMPLETE,function(r){r=r.target.content.bitmapData;g.bitmaps=new runtime.Array(r);try{a._badge&&(a._badge.customIcon=new runtime.flash.display.Bitmap(r))}catch(w){}});
b.load(new air.URLRequest("app:/"+k));if(!c.supportsDockIcon){c=new air.NativeMenu;k=new air.NativeMenuItem(u("exit"));s(k,air.Event.SELECT,function(){e.exit()});c.addItem(k);g.menu=c}}}},_initEvents:function(){},render:function(){x.body.appendChild(this.window.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=b.container,e=C(b,{main:false,closeable:false,subHeader:a.header}),g=a.element;this.widgets[a.name]=a;a.widget_title=b.title;if(c=="window"){c=new z.window(null,
e);c.content(g);a.container=c}else if(c=="tab"){this.tabs.add(a.element,b.title,b.icon);this.tabs.select(b.title)}},showWidget:function(a){this.tabs.select(this.widgets[a].widget_title)},focusChat:function(a,b){b=h(a,b);var c=this.chatWindows[b],e=this.chats[b];c&&c.activate();e&&e.focus()},chat:function(a,b){return this.chats[h(a,b)]},updateChat:function(a,b){b=Q(b);for(var c,e=b.length,g,k=0;k<e;k++){c=b[k];(g=this.chats[h(a,c.id)])&&g.update(c)}},updateAllChat:function(){F(this.chats,function(a,
b){b.update()})},addChat:function(a,b,c){var e=this,g=e.chats;b=h(a,b);if(!g[b]){a=e.chatWindows[b]=(new z.window(null,{main:false,name:"chat",title:"webim",maximizable:true,icon:""})).a("close",function(){delete e.chatWindows[b];delete e.chats[b]});c.setWindow(a);g[b]=c}},removeChat:function(a,b){var c=this.chatWindows[h(a,b)];c&&c.close()},removeAllChat:function(){F(this.chatWindows,function(a,b){b.close()})},showContent:function(){R(this.$.widgets,"webim-hide");R(this.tabs.element,"webim-hide");
R(this.$.shortcut,"webim-hide")},setBadge:function(a){try{this._badge.label=a.toString()}catch(b){}},notifyUser:function(a){t.runtime&&air.NativeApplication.supportsDockIcon&&air.NativeApplication.nativeApplication.icon.bounce(a)}});d("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){J.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML=
"";this.d("clear")},add:function(a){a=Q(a);var b=a.length,c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.d("update")}},_renderMsg:function(a){a=C({},a);J.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,g=a.body,k=true,o=this._lastLogItem,m=[],r;r=a.nick;if(o&&o.to==c&&o.from==b&&e-o.timestamp<6E4)k=false;if(k){this._lastLogItem=a;a=new T(e);m.push('<h4><span class="webim-gray">');m.push(a.getDay(true));m.push(" ");
m.push(a.getTime());m.push("</span>");m.push(r);m.push('</h4><hr class="webim-line ui-state-default" />')}m.push("<p>");m.push(g);m.push("</p>");return m.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,g=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){g.push("<h5>");g.push((new T(a)).getDay(true));g.push("</h5>")}return g.join("")},ui:function(a){return C({element:this.element,$:this.$},a)},plugins:{}});var W=
function(){function a(e,g){return'<a href="'+(g=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>"}function b(e,g){c+=" "+e+'="'+g+'"'}var c;return function(e,g){c="";g&&E(g)&&F(g,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();z.history.defaults.parseMsg=true;J.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=aa(c);c=W(c,{target:"_blank"});b.msg.body=c}});z.history.defaults.emot=true;J.add("history","emot",{render:function(a,b){b.msg.body=z.emot.parse(b.msg.body)}});d("emot",
{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;F(b.firstChild.childNodes,function(c,e){s(e,"click",function(){R(b,"webim-emot-show");a.d("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');F(a,function(c,e){var g=e.src,k=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(g);b.push('" title="');b.push(k);b.push('" alt="');b.push(e.q[0]);
b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return D(this.options.template,{emots:b.join("")})},toggle:function(){O(this.element,"webim-emot-show")}});C(z.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},
{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=C({dir:"webim/static/emot/default"},
a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";F(b.emots,function(g,k){if(k&&k.src)k.src=e+k.src;k&&k.q&&F(k.q,function(o,m){c[m]=g})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&F(b,function(e,g){var k=c[g],o=k.src,m=k.t?k.t:k.q[0],r=[];r.push('<img src="');r.push(o);r.push('" title="');r.push(m);r.push('" alt="');r.push(k.q[0]);r.push('" />');e=aa(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),r.join(""))});
return a}});f("chat",function(a){a=a||{};var b=this.im,c=b.buddy,e=b.room,g=b.history,k=a.info,o=k.id,m=a.type;if(m=="room"){k.presence="online";var r=g.get("multicast",o);r||g.load("multicast",o);C(a,{history:r,block:true,emot:true,clearHistory:false,member:true,type:m,downloadHistory:false});var w=new z.chat(null,a);w.a("sendMessage",function(p,B){b.sendMessage(B);g.set(B)}).a("downloadHistory",function(p,B){g.download("multicast",B.id)}).a("select",function(p,B){B.presence="online";c.presence(B);
self.addChat("buddy",B.id,B.nick);layout.focusChat("buddy",B.id)}).a("block",function(p,B){e.block(B.id)}).a("unblock",function(p,B){e.unblock(B.id)}).a("destroy",function(){w.options.info.blocked&&e.leave(o)});setTimeout(function(){w.options.info.blocked?e.join(o):e.initMember(o)},500);v(k.members)&&F(k.members,function(p,B){w.addMember(B.id,B.nick,B.id==b.data.user.id)})}else{(r=g.get("unicast",o))||g.load("unicast",o);C(a,{history:r,block:false,emot:true,clearHistory:true,member:false,type:m,downloadHistory:false});
w=new z.chat(null,a);w.a("sendMessage",function(p,B){b.sendMessage(B);g.set(B)}).a("sendStatus",function(p,B){b.sendStatus(B)}).a("clearHistory",function(p,B){g.clear("unicast",B.id)}).a("downloadHistory",function(p,B){g.download("unicast",B.id)})}return w});d("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat webim-box webim-flex"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content webim-flex webim-box-h">                                                                                                                 <div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div><div id=":sidebar" class="webim-chat-sidebar webim-box"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.element,b=this.options,c=b.window,e=this.history=new z.history(null,{user:b.user,info:b.info});N(a,"webim-chat-"+b.type);this.$.main.insertBefore(e.element,this.$.main.firstChild);this.header=L(D(b.tpl_header));C(this.$,P(this.header));c&&this.setWindow(c);b.simple&&G(this.header);this.update(b.info);e.add(b.history);J.call(this,"init",[null,this.ui()]);this._adjustContent()},setWindow:function(a){this.window=a;a.header(this.header);a.content(this.element);a.title(this.options.info.nick);
this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(u("buddy offline notice",{name:this.options.info.nick}));else this.notice(u("user offline notice"));J.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;t.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,e=
c.$.notice,g=c._noticeTime;g&&clearTimeout(g);if(a)if(b){e.innerHTML=a;K(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=c._noticeTxt;else G(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;K(e)}else{c._noticeTxt=null;G(e)}},_adjustContent:function(){var a=this.$.main;if(a.scrollHeight-a.scrollTop-a.clientHeight<200)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.a("displayStateChange",function(b,c){if(c!="minimize"){t.setTimeout(function(){a.$.input.focus()},
0);a._adjustContent()}}).a("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},_sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"multicast":"unicast",to:c.id,from:b.user.id,nick:b.user.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};J.call(this,"send",[null,this.ui({msg:a})]);this.d("sendMessage",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",
true);return true}else{var b=ja(a),c=b.value;if(M(c).length){this._sendMessage(c);b.value="";I(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ja(a);(t.getSelection?t.getSelection().toString():x.selection?x.selection.createRange().text:"")||t.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=u("input notice"),e=b.input;a.history.a("update",function(){a._adjustContent()}).a("clear",function(){a.notice(u("clear history notice"),3E3)});s(e,"keyup",function(){j.call(this)});
s(e,"click",j);s(e,"select",j);s(e,"focus",function(){R(this,"webim-gray");if(this.value==c)this.value=""});s(e,"blur",function(){if(this.value==""){N(this,"webim-gray");this.value=c}});s(e,"keypress",function(g){a._inputkeypress(g)});s(b.main,"click",function(g){a._onFocusInput(g)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",
a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=Y(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,g=c.selectionStart,k=c.selectionEnd,o=e.substring(0,g);e=e.substring(k);k=a.length;c.value=o+a+e;c.setSelectionRange(g+k,g+k)}else if(x.selection)if(g=c.caretPos){g.text=a;g.collapse();g.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||
a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.d("sendStatus",{to:this.options.info.id,show:a})}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=t.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":c+u(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!=
"")this._setST=t.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.d("destroy")},ui:function(a){return C({self:this,$:this.$,history:this.history},a)},plugins:{}});z.chat.defaults.emot=true;J.add("chat","emot",{init:function(a,b){var c=b.self,e=new z.emot;e.a("select",function(k,o){c.focus();c.insert(o,true)});var g=L(D('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));s(g,"click",function(k){I(k);e.toggle()});b.$.toolContent.appendChild(e.element);
b.$.tools.appendChild(g)},send:function(){}});z.chat.defaults.clearHistory=true;J.add("chat","clearHistory",{init:function(a,b){var c=b.self,e=L(D('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));s(e,"click",function(g){I(g);c.d("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});z.chat.defaults.block=true;J.add("chat","block",{init:function(a,b){var c=b.self,e=c.options.info.blocked,g=c.options.info.nick,k=L('<a href="#chat-block" style="display:'+
(e?"none":"")+'" title="'+u("block group",{name:g})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),o=L('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+u("unblock group",{name:g})+'"><em class="webim-icon webim-icon-block"></em></a>');s(k,"click",function(m){I(m);G(k);K(o);c.d("block",[c.options.info])});s(o,"click",function(m){I(m);G(o);K(k);c.d("unblock",[c.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(o)}});z.chat.defaults.member=true;C(z.chat.prototype,
{addMember:function(a,b,c){var e=this,g=e.memberLi;if(!g[a]){var k=L('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");s(k.firstChild,"click",function(o){I(o);c||e.d("select",[{id:a,nick:b}])});g[a]=k;e.$.member.appendChild(k);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});
J.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=L(D('<div class="webim-box webim-flex  webim-member ui-widget-content"><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul" class="webim-flex"></ul></div>')),g=P(e);c.member=g.ul;c.memberCount=g.memberCount;c.sidebar.appendChild(e)}});z.chat.defaults.downloadHistory=true;J.add("chat","downloadHistory",{init:function(a,b){var c=b.self,e=L(D('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));
s(e,"click",function(g){I(g);c.d("downloadHistory",[c.options.info])});b.$.tools.appendChild(e)}});f("setting",{init:function(a){var b=this.im.setting,c=this.layout,e=this.setting=new z.setting(null,a);c.addWidget(e,{title:u("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(g,k){typeof k!="object"&&e.check_tag(g,k)});e.bind("change",function(g,k){b.set(g,k)})},stop:function(){}});d("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',
tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],c=a.options.data;c&&F(c,function(e,g){g&&typeof g!="boolean"||b.push(a._check_tpl(e,g))});return D(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&F(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return D(this.options.tpl_check,
{label:u(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;s(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var c=this;if(E(a))F(a,function(k,o){c.check_tag(k,o)});else{var e=c.$,g=e[a];if(!(b&&typeof b!="boolean"))if(g)g.firstChild.checked=b;else{g=e[a]=L(c._check_tpl(a,b));c._check_event(g);e.ul.appendChild(g)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});f("user",function(a){a=a||{};var b=
this.im,c=new z.user;G(c.element);a.container&&a.container.appendChild(c.element);c.a("online",function(e,g){b.online(g)}).a("offline",function(){b.offline()}).a("presence",function(e,g){b.sendPresence(g)});c.update(b.data.user);b.a("online",function(){K(c.element);c.update(b.data.user)}).a("offline",function(){c.show("unavailable")});return c});d("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;s(b.userShowTrigger,"click",function(e){c.style.display=="block"?G(c):K(c);I(e)});F(ba(c.firstChild),function(e,g){s(g,"click",function(k){a._set(this.href.split("#")[1]);G(c);I(k)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=Y(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?
a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=u(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.d("offline",[]);else b.show=="unavailable"?this.d("online",[{show:a}]):this.d("presence",[{show:a,status:b.status}])}else a!="unavailable"&&
this.d("online",[{show:a}])},destroy:function(){}});f("login",function(a){a=a||{};var b=this.im,c=new z.login(null,a);a.container&&a.container.appendChild(c.element);c.a("login",function(e,g){b.online(g)});b.a("online",function(){c.hide()}).a("offline",function(e,g,k){g=="online"&&c.showError(k)});return c});d("login",{questions:null,notice:"",template:'<div>  \t\t<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?F(a,function(c,e){var g=x.createElement("option");g.value=e[0];g.innerHTML=e[1];b.question.appendChild(g)}):G(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ia(b.submit,"ui-state-hover");s(b.form,"submit",function(c){I(c);a.d("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){G(this.element)},show:function(){K(this.element)},
hideError:function(){G(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=u(a);K(b)},destroy:function(){}});f("buddy",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,g=b.layout,k=new z.buddy(null,C({title:u("buddy")},a));g.addWidget(k,{container:"tab",title:u("buddy"),icon:"buddy"});k.a("select",function(w,p){b.addChat("buddy",p.id);b.layout.focusChat("buddy",p.id)});var o=function(w){return E(w)?w.id:w},m=function(w){return w.show!="invisible"&&w.presence=="online"},r=function(w){return w.show==
"invisible"};e.a("online",function(w,p){k.add(Z(p,m))});e.a("offline",function(w,p){k.remove(la(p,o))});e.a("update",function(w,p){k.add(Z(p,m));k.update(Z(p,m));k.remove(la(Z(p,r),o))});k.offline();c.a("beforeOnline",function(){k.online()}).a("online",function(){k.titleCount()}).a("offline",function(){k.offline()});return k});d("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&N(this.element,"webim-buddy-hidegroup");a.simple&&N(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,g=u("search buddy");s(c.firstChild,"click",function(){e.focus()});e.value=g;s(e,"focus",function(){N(c,"ui-state-active");if(this.value==g)this.value=""});s(e,"blur",function(){R(c,"ui-state-active");if(this.value=="")this.value=g});s(e,"keyup",function(){var k=
this.value;F(a.li,function(o,m){k&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?G(m):K(m)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?G(c):K(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){O(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+u(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");G(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();G(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var c=b.show?b.show:"available";a.className="webim-icon webim-icon-"+c;a.setAttribute("title",
u(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=Y(b.status)||"&nbsp;";return a},_addOne:function(a,b){var c=this,e=c.li,g=a.id,k=c.$.ul;if(!e[g]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=Y(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=u(a.show);a.pic_url=a.pic_url||"";e=e[g]=L(D(c.options.tpl_li,
a));s(e.firstChild,"click",function(r){I(r);c.d("select",[a]);this.blur()});var o=c.groups,m=u(a.group||"friend");o=o[m];if(!o){o=L(D(c.options.tpl_group));G(o);if(m==u("stranger"))b=true;b?k.appendChild(o):k.insertBefore(o,k.firstChild);o={name:m,el:o,count:0,title:o.firstChild,li:o.lastChild};c.groups[m]=o}o.count==0&&K(o.el);c.li_group[g]=o;o.li.appendChild(e);o.count++;o.title.innerHTML=m+"("+o.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=
Q(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=Q(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,g,k=this.li_group;a=l(a);for(var o=0;o<a.length;o++){b=a[o];if(c=e[b]){this.size--;if(g=k[b]){g.count--;g.count==0&&G(g.el);g.title.innerHTML=g.name+"("+g.count+")"}c&&c.parentNode&&c.parentNode.removeChild(c);delete e[b]}}this.titleCount()},
select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});f("room",function(){function a(m){var r=m.nick;m=C({},m,{group:"group",nick:r+"("+(parseInt(m.count)+"/"+parseInt(m.all_count))+")"});k.updateChat(m);m.blocked&&(m.nick=r+"("+u("blocked")+")");o.li[m.id]?o.update(m):o.add(m)}var b=this,c=b.im,e=c.room,g=c.setting,k=b.layout,o=b.room=(new webim.ui.room(null)).a("select",function(m,r){b.addChat("room",r.id);b.layout.focusChat("room",r.id)});k.addWidget(o,{container:"tab",
title:u("room"),icon:"room"});c.setting.a("update",function(){});e.a("join",function(m,r){a(r)}).a("leave",function(){}).a("block",function(m,r,w){g.set("blocked_rooms",w);a(e.get(r));e.leave(r)}).a("unblock",function(m,r,w){g.set("blocked_rooms",w);a(e.get(r));e.join(r)}).a("addMember",function(m,r){a(e.get(r))}).a("removeMember",function(m,r){a(e.get(r))})});d("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;K(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,g=u("search room");s(c.firstChild,"click",function(){e.focus()});e.value=g;s(e,"focus",function(){N(c,
"ui-state-active");if(this.value==g)this.value=""});s(e,"blur",function(){R(c,"ui-state-active");if(this.value=="")this.value=g});s(e,"keyup",function(){var k=this.value;F(a.li,function(o,m){k&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?G(m):K(m)})})},scroll:function(a){O(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,g=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=L(D(b.options.tpl_li,a));s(c.firstChild,"click",function(k){I(k);b.d("select",[a]);this.blur()});g.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=Q(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){G(this.$.empty);a=Q(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);
this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=l(a);for(var g=0;g<a.length;g++){b=a[g];if(c=e[b]){c&&c.parentNode&&c.parentNode.removeChild(c);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});f("menu",{init:function(a){var b=this.layout;a=this.menu=new z.menu(null,a);b.addWidget(a,{title:u("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},
null,"shortcut")}});d("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&G(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&F(c,function(e,g){b.push(a._li_tpl(g))});return D(a.options.template,
{list:b.join("")})},_li_tpl:function(a){return D(this.options.tpl_li,{title:u(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(v(a))F(a,function(e,g){b.add(g)});else{var c=b.$;G(c.empty);c.ul.appendChild(L(b._li_tpl(a)))}},destroy:function(){}});d("tabs",{template:'<div class="webim-tabs">\t\t<ul id=":nav" class="webim-tabs-nav ui-helper-clearfix"></ul>\t\t\t</div>',panel:false},
{_init:function(){this.panels={};this.navs={}},add:function(a,b){var c=this.$.nav,e=this.navs[b]=L('<li class="ui-corner-top ui-state-default"><a href="#">'+b+"</a></li>");N(a=a?a.nodeType?a:x.getElementById(a):null,"ui-helper-hidden-accessible");this.panels[b]=a;c.appendChild(e);this.options.panel&&this.options.panel.appendChild(a);this._tabEvent(e,b)},select:function(a){if(a=this.navs[a]){a=ba(a.firstChild)[0];if(x.createEvent){var b=x.createEvent("HTMLEvents");b.initEvent("click",true,true);a.dispatchEvent(b)}a.fireEvent&&
a.fireEvent("onclick")}},_tabEvent:function(a,b){var c=this,e=ba(a.firstChild)[0];s(e,"click",function(g){F(c.panels,function(k,o){N(o,"ui-helper-hidden-accessible")});F(c.navs,function(k,o){R(o,"ui-state-active")});R(c.panels[b],"ui-helper-hidden-accessible");N(c.navs[b],"ui-state-active");I(g)})}})})(window,document);
