(function(s,u,V){function $(){return(new Date).getTime()}function N(c){return L.call(c)==="[object Function]"}function O(c){return L.call(c)==="[object Array]"}function W(c){return c&&L.call(c)==="[object Object]"}function H(c){return(c||"").replace(/^\s+|\s+$/g,"")}function J(c,e){var g=false;if(W(e)){c=c||{};for(var i in e){var j=e[i];if(c[i]!=j){g=g||{};g[i]=j}}}return g}function aa(c){var e=[];if(c!=null){var g=c.length;if(g==null||typeof c==="string"||N(c)||c.setInterval)e[0]=c;else for(;g;)e[--g]=
c[g]}return e}function A(){var c=arguments[0]||{},e=1,g=arguments.length,i=false,j;if(typeof c==="boolean"){i=c;c=arguments[1]||{};e=2}if(typeof c!=="object"&&!N(c))c={};for(;e<g;e++)if((j=arguments[e])!=null)for(var n in j){var r=c[n],v=j[n];if(c!==v)if(i&&v&&typeof v==="object"&&!v.nodeType)c[n]=A(i,r||(v.length!=null?[]:{}),v);else if(v!==V)c[n]=v}return c}function D(c,e,g){var i,j=0,n=c.length,r=n===V||N(c);if(g)if(r)for(i in c){if(e.apply(c[i],g)===false)break}else for(;j<n;){if(e.apply(c[j++],
g)===false)break}else if(r)for(i in c){if(e.call(c[i],i,c[i])===false)break}else for(g=c[0];j<n&&e.call(g,j,g)!==false;g=c[++j]);return c}function B(c,e){for(var g=[],i,j=0,n=c.length;j<n;j++){i=e(c[j],j);if(i!=null)g[g.length]=i}return g.concat.apply([],g)}function t(c){var e=[];if(typeof c=="object"){for(var g in c)e[e.length]=encodeURIComponent(g)+"="+encodeURIComponent(c[g]);return e.join("&").replace(ea,"+")}return c}function F(c){c=A(true,c,A(true,{},X,c));var e,g,i=c.context||s,j=c.type.toUpperCase();
if(c.data&&c.processData&&typeof c.data!=="string")c.data=t(c.data);if(c.cache===false&&j==="GET"){var n=$(),r=c.url.replace(ha,"$1_="+n+"$2");c.url=r+(r===c.url?(ba.test(c.url)?"&":"?")+"_="+n:"")}if(c.data&&j==="GET")c.url+=(ba.test(c.url)?"&":"?")+c.data;var v=false,o=c.xhr();c.username?o.open(j,c.url,c.async,c.username,c.password):o.open(j,c.url,c.async);try{c.data&&o.setRequestHeader("Content-Type",c.contentType);if(c.ifModified){fa[c.url]&&o.setRequestHeader("If-Modified-Since",fa[c.url]);R[c.url]&&
o.setRequestHeader("If-None-Match",R[c.url])}o.setRequestHeader("X-Requested-With","XMLHttpRequest");o.setRequestHeader("Accept",c.dataType&&c.accepts[c.dataType]?c.accepts[c.dataType]+", */*":c.accepts._default)}catch(y){}if(c.beforeSend&&c.beforeSend.call(i,o,c)===false){o.abort();return false}var P=function(b){if(!o||o.readyState===0){if(G){clearInterval(G);G=null}}else if(!v&&o&&(o.readyState===4||b==="timeout")){v=true;if(G){clearInterval(G);G=null}var d;if(b==="timeout")d="timeout";else{a:{try{d=
!o.status&&location.protocol==="file:"||o.status>=200&&o.status<300||o.status===304||o.status===1223||o.status===0;break a}catch(f){}d=false}if(d){if(d=c.ifModified){d=o;var h=c.url,k=d.getResponseHeader("Last-Modified"),l=d.getResponseHeader("Etag");if(k)fa[h]=k;if(l)R[h]=l;d=d.status===304||d.status===0}d=d?"notmodified":"success"}else d="error";d=d}e=d;if(e==="success")try{d=o;var m=c.dataType;h=c;var p=d.getResponseHeader("content-type"),q=m==="xml"||!m&&p&&p.indexOf("xml")>=0,K=q?d.responseXML:
d.responseText;if(q&&K.documentElement.nodeName==="parsererror")throw"parsererror";if(h&&h.dataFilter)K=h.dataFilter(K,m);if(typeof K==="string")if(m==="json")K=typeof M==="object"&&M.parse?M.parse(K):(new Function("return "+K))();g=K}catch(S){e="parsererror"}if(e==="success"||e==="notmodified")c.success&&c.success.call(i,g,e);else if(c.error)c.error.call(c.context||s,o,e,void 0);c.complete&&c.complete.call(i,o,e);b&&o.abort();if(c.async)o=null}};if(c.async){var G=setInterval(P,13);c.timeout>0&&setTimeout(function(){o&&
!v&&P("timeout")},c.timeout)}try{o.send(j==="POST"||j==="PUT"?c.data:null)}catch(a){if(c.error)c.error.call(c.context||s,o,null,a)}c.async||P();return o}function T(c){function e(){var k=P.document;G=G||k.getElementsByTagName("head")[0]||k.documentElement;y=k.createElement("script");y.src=c.url;if(z.async)y.async=c.async;if(c.scriptCharset)y.charset=c.scriptCharset;y.onload=y.onerror=y.onreadystatechange=function(){if(!h&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){i("error");
g()}};G.insertBefore(y,G.firstChild);if(!z.defaultAsync&&!z.events){k=k.createElement("script");k.appendChild(u.createTextNode("try{"+(b?"parent.":"")+o+"()}catch(e){};"));G.insertBefore(k,G.firstChild);G=k=null}}function g(){h=true;s[v]=V;try{delete s[v]}catch(k){}s[o]=V;try{delete s[o]}catch(l){}y.onload=y.onreadystatechange=null;y.parentNode&&y.parentNode.removeChild(y);a&&a.parentNode&&a.parentNode.removeChild(a);y=a=G=null}function i(k){c.error&&c.error.call(r,k)}c=A({},C,c);var j="",n=/%20/g,
r=c.context||s,v="jsonp"+ia++,o=v+"error",y,P=s,G,a,b=c.async&&!z.fragmentProxy&&!z.defaultAsync&&!z.async;if(typeof c.data=="object"){var d=[];for(var f in c.data)d[d.length]=encodeURIComponent(f)+"="+encodeURIComponent(c.data[f]);j+=d.join("&").replace(n,"+")}else j+=c.data;j=(j?j+"&":"")+(c.jsonp||"callback")+"="+(b?"parent.":"")+v;c.url+=(/\?/.test(c.url)?"&":"?")+j;var h=false;s[v]=function(k){c.success&&c.success.call(r,k,"success");g()};s[o]=function(){if(!h){i("error");g()}};c.timeout>0&&
setTimeout(function(){if(!h){i("timeout");g();s[v]=Y}},c.timeout);if(c.async&&!z.defaultAsync&&z.fragmentProxy)G=a=u.createDocumentFragment();if(b){j=s.location;if(c.url.slice(0,1)=="/")c.url=j.protocol+"//"+j.host+(j.port?":"+j.port:"")+c.url;else if(!/^https?:\/\//i.test(c.url)){j=j.href;n=/([^?#]+)\//.exec(j);c.url=(n?n[1]:j)+"/"+c.url}a=u.createElement("iframe");a.style.position="absolute";a.style.left="-100px";a.style.top="-100px";a.style.height="1px";a.style.width="1px";a.style.visibility="hidden";
u.body.appendChild(a);P=a.contentWindow}b?setTimeout(function(){e()},0):e();return V}function Y(){}function ga(c,e){this._setting();this.options={jsonp:false,server:null,ticket:null,domain:null,timeout:4E4,url:{send:null}};A(this.options,e)}function Q(c,e,g){if(typeof e!="undefined"){g=g||{};if(e===null){e="";g=A({},g);g.expires=-1}var i="";if(g.expires&&(typeof g.expires=="number"||g.expires.toUTCString)){if(typeof g.expires=="number"){i=new Date;i.setTime(i.getTime()+g.expires*24*60*60*1E3)}else i=
g.expires;i="; expires="+i.toUTCString()}var j=g.path?"; path="+g.path:"",n=g.domain?"; domain="+g.domain:"";g=g.secure?"; secure":"";u.cookie=[c,"=",encodeURIComponent(e),i,j,n,g].join("")}else{e=null;if(u.cookie&&u.cookie!=""){g=u.cookie.split(";");for(i=0;i<g.length;i++){j=H(g[i]);if(j.substring(0,c.length+1)==c+"="){e=decodeURIComponent(j.substring(c.length+1));break}}}return e}}function x(c,e){if(ca){var g=new Date,i=["[",g.getHours(),":",g.getMinutes(),":",g.getSeconds(),"-",g.getMilliseconds(),
"]"].join("");g=i+e+M.stringify(c);s.console&&s.console.log(i,e,c);i=u.getElementById("webim-log");if(s.runtime&&s.air){s.air.trace(g);s.air.Introspector&&s.air.Introspector.Console.log(g)}if(i){var j=u.createElement("P");j.innerHTML=g;i.appendChild(j)}}}function w(c,e){this.options=A({},w.defaults,e);this._init(c,e)}function da(c){return c&&c.split?c.split(","):O(c)?c:parseInt(c)?[parseInt(c)]:[]}function E(c,e,g){function i(j,n){this.data=j;this.options=A({},i.defaults,n);N(this._init)&&this._init()}
i.defaults=e;A(i.prototype,U,g);w[c]=i}function I(c){return I[c]}var L=Object.prototype.toString,U={option:function(c,e){var g=c;this.options=this.options||{};if(typeof c=="string"){if(e===V)return this.options[c];g={};g[c]=e}A(this.options,g);return this},bind:function(c,e){var g=this._events=this._events||{};if(N(e)){g[c]=g[c]||[];g[c].push(e)}return this},trigger:function(c,e){var g=(this._events=this._events||{})[c];if(!g)return this;e=O(e)?e:aa(e);for(var i=0,j=g.length;i<j;i++)g[i].apply(this,
e);return this},unbind:function(c,e){var g=this._events=this._events||{};if(!g[c])return this;if(N(e)){g=g[c];for(var i=g.length;i--;)g[i]===e&&g.splice(i,1)}else delete g[c];return this}},ea=/%20/g,ia=$(),ba=/\?/,ha=/(\?|&)_=.*?(&|$)/,X={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return s.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",
script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},fa={},R={},C={url:location.href,timeout:5E3,jsonp:"callback",async:false},z=s.jsonpSupport={async:typeof u.createElement("script").async=="boolean",events:false,defaultAsync:false,fragmentProxy:false};(function(){var c=navigator.userAgent.toLowerCase();z.events=!/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(c);z.defaultAsync=!!/(webkit)[ \/]([\w.]+)/.exec(c);c=u.createDocumentFragment();
var e=u.createElement("script");text="window.jsonpSupport.fragmentProxy = true";try{e.appendChild(u.createTextNode(text))}catch(g){e.text=text}c.appendChild(e)})();var M=s.JSON?s.JSON:function(){function c(i){return g[i]||"\\u00"+Math.floor(i.charCodeAt()/16).toString(16)+(i.charCodeAt()%16).toString(16)}function e(i){switch(Object.prototype.toString.call(i)){case "[object String]":return'"'+i.replace(/[\x00-\x1f\\"]/g,c)+'"';case "[object Array]":for(var j=[],n=i.length,r=0;r<n;r++)j.push(e(i[r]));
return"["+j.join(",")+"]";case "[object Object]":j=[];for(n in i)(r=e(i[n]))&&j.push(e(n)+":"+r);return"{"+j+"}";case "[object Number]":case "[object Boolean]":return String(i);case false:return"null"}return null}var g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:e,parse:function(i){i=i.toString();if(!i||!i.length)return null;return(new Function("return "+i))()}}}();A(ga.prototype,U,{_setting:function(){this._onPolling=this._connecting=this.connected=
false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},connect:function(c){var e=this;A(e.options,c);if(e._connecting)return e;e._connecting=true;c=e.options;e._onPolling||s.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.connected=true;this.trigger("connect","success")},_onClose:function(c){this._setting();this.trigger("close",[c])},_onData:function(c){this.trigger("data",
c)},_onError:function(c){this._setting();this.trigger("error",c)},_startPolling:function(){var c=this.options;this._onPolling=true;this._pollingTimes++;var e={url:c.server,data:{domain:c.domain,ticket:c.ticket},dataType:"json",timeout:c.timeout,cache:false,context:this,success:this._onPollSuccess,error:this._onPollError};if(c.jsonp){A(e,{timeout:c.timeout,dataType:"jsonp",async:true,jsonp:"callback"});T(e)}else F(e)},_onPollSuccess:function(c){var e=this;e._onPolling=false;if(e._connecting)if(!c||
!c.status)return e._onError("error data");else{e._pollingTimes==1&&e._onConnect();e._onData(c);e._failTimes=0;e._pollTimer=s.setTimeout(function(){e._startPolling()},200)}},_onPollError:function(c){var e=this;e._onPolling=false;if(e._connecting){e._failTimes++;if(e._pollingTimes==1)e._onError("can not connect.");else if(e._failTimes>1)e._onClose(c);else e._pollTimer=s.setTimeout(function(){e._startPolling()},200)}}});var ca=true;x.enable=function(){ca=true};x.disable=function(){ca=false};A(w.prototype,
U,{_init:function(){var c=this.options,e={presence:"offline",show:"unavailable"};this.request=c.jsonp?T:F;this.data={user:e};this.status=new w.status;this.setting=new w.setting(null,{jsonp:c.jsonp});this.buddy=new w.buddy(null,{active:this.status.get("b"),jsonp:c.jsonp});this.room=new w.room(null,{user:e,jsonp:c.jsonp});this.history=new w.history(null,{user:e,jsonp:c.jsonp});this.connection=new ga(null,{jsonp:s.location.protocol=="app:"?false:true});this._initEvents()},user:function(c){A(this.data.user,
c)},_ready:function(c){var e=this;e._unloadFun=s.onbeforeunload;s.onbeforeunload=function(){e._refresh()};e.trigger("ready",[c])},_go:function(){var c=this.data,e=this.history,g=this.buddy,i=this.room;e.option("userInfo",c.user);D(c.buddies,function(n,r){e.init("unicast",r.id,r.history)});g.handle(c.buddies);D(c.rooms,function(n,r){e.init("multicast",r.id,r.history)});g=this.setting.get("blocked_rooms");var j=c.rooms;O(g)&&j&&D(g,function(n,r){j[r]&&(j[r].blocked=true)});i.handle(j);i.options.ticket=
c.connection.ticket;this.trigger("go",[c]);this.connection.connect(c.connection);if((c=c.new_messages)&&c.length){D(c,function(n,r){r["new"]=true});this.trigger("message",[c])}},_stop:function(c,e){s.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("stop",[c,e])},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function c(j){var n={id:j.from,presence:j.type};if(j.show)n.show=j.show;if(j.nick)n.nick=
j.nick;if(j.status)n.status=j.status;return n}var e=this,g=e.history,i=e.buddy;e.connection.bind("connect",function(){}).bind("data",function(j){e.handle(j)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){e._stop("connect","Disconnect")});e.bind("message",function(j){for(var n=[],r=j.length,v=e.data.user.id,o,y,P,G=0;G<r;G++){o=j[G];P=o.type;y=P=="unicast"?o.to==v?o.from:o.to:o.to;o.id=y;if(P=="unicast"&&!o["new"]){y={id:y,presence:"online"};if(o.nick)y.nick=
o.nick;n.push(y)}}if(n.length){i.presence(n);i.complete()}g.handle(j)});e.bind("presence",function(j){i.presence(B(j,c))})},handle:function(c){c.messages&&c.messages.length&&this.trigger("message",[c.messages]);c.presences&&c.presences.length&&this.trigger("presence",[c.presences]);c.statuses&&c.statuses.length&&this.trigger("status",[c.statuses])},sendMsg:function(c){c.ticket=this.data.connection.ticket;this.trigger("sendMsg",[c]);this.request({type:"post",url:this.options.urls.message,cache:false,
data:c})},sendStatus:function(c){c.ticket=this.data.connection.ticket;this.request({type:"post",url:this.options.urls.status,cache:false,data:c})},sendPresence:function(c){c.ticket=this.data.connection.ticket;this.data.user.show=c.show;this.status.set("s",c.show);this.request({type:"post",url:this.options.urls.presence,cache:false,data:c})},online:function(c){var e=this,g=e.status,i=[],j=[],n=g.get("tabs"),r=g.get("tabIds");r&&r.length&&n&&D(n,function(v){v[0]=="b"&&i.push(v.slice(2));v[0]=="r"&&
j.push(v.slice(2))});c=A({buddy_ids:i.join(","),room_ids:j.join(","),show:g.get("s")||"available"},c);e._ready(c);g.set("o",false);g.set("s",c.show);e.request({type:"post",dataType:"json",data:c,url:e.options.urls.online,success:function(v){if(v)if(v.success){v.user=A(e.data.user,v.user,{presence:"online"});e.data=v;e._go()}else e._stop("online",v.error_msg);else e._stop("online","Not Found")},error:function(){e._stop("online","Not Found")}})},offline:function(){var c=this.data;this.status.set("o",
true);this.connection.close();this._stop("offline","offline");this.request({type:"post",url:this.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:c.connection.ticket}})},_refresh:function(){var c=this.data;!c||!c.connection||!c.connection.ticket||this.request({type:"post",url:this.options.urls.refresh,type:"post",cache:false,data:{ticket:c.connection.ticket}})}});s.webim=w;A(w,{version:"1.1.0",defaults:{urls:{online:"webim/online",offline:"webim/offline",message:"webim/message",
presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:x,idsArray:da,now:$,isFunction:N,isArray:O,isObject:W,trim:H,makeArray:aa,extend:A,each:D,inArray:function(c,e){for(var g=0,i=e.length;g<i;g++)if(e[g]===c)return g;return-1},grep:function(c,e,g){for(var i=[],j=0,n=c.length;j<n;j++)!g!==!e(c[j],j)&&i.push(c[j]);return i},map:B,JSON:M,ajax:F,jsonp:T,comet:ga,model:E,route:I,objectExtend:U});E("setting",{url:"/webim/setting",data:{blocked_rooms:[],play_sound:true,buddy_sticky:true,
minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.request=this.options.jsonp?T:F;this.data=A({},this.options.data,this.data)},get:function(c){return this.data[c]},set:function(c,e){var g=this,i=c;if(c){if(typeof c=="string"){i={};i[c]=e}var j=g.data,n=J(j,i);if(n){D(n,function(r,v){g.trigger("update",[r,v])});i=A({},j,i);g.data=i;g.request({type:"post",url:g.options.url,dataType:"json",cache:false,data:{data:M.stringify(i)}})}}}});E("status",{key:"_webim"},{_init:function(){var c=this.data;
if(c)this._save(c);else this.data=(c=Q(this.options.key))?M.parse(c):{}},set:function(c,e){var g=c;if(typeof c=="string"){g={};g[c]=e}var i=this.data;J(i,g)&&this._save(A({},i,g))},get:function(c){return this.data[c]},clear:function(){this._save({})},_save:function(c){this.data=c;Q(this.options.key,M.stringify(c),{path:"/",domain:u.domain})}});E("buddy",{url:"/webim/buddy"},{_init:function(){this.request=this.options.jsonp?T:F;this.data=this.data||[];this.dataHash={};this.handle(this.data)},clear:function(){this.data=
[];this.dataHash={}},count:function(c){var e=this.dataHash,g=0,i;for(var j in e)if(W(c)){i=true;for(var n in c)if(c[n]!=e[j][n])i=false;i&&g++}else g++;return g},get:function(c){return this.dataHash[c]},complete:function(){var c=this.dataHash,e=[],g;for(var i in c){g=c[i];if(g.incomplete&&g.presence=="online"){g.incomplete=false;e.push(i)}}this.load(e)},update:function(c){this.load(c)},presence:function(c){var e=this.dataHash;c=O(c)?c:[c];for(var g in c){var i=c[g];i.presence=i.presence=="offline"?
"offline":"online";i.incomplete=!e[i.id]}this.handle(c)},load:function(c){c=da(c);c.length&&this.request({type:"get",url:this.options.url,async:true,cache:false,dataType:"json",data:{ids:c.join(",")},context:this,success:this.handle})},handle:function(c){var e=this.data,g=this.dataHash,i={};c=c||[];var j,n;for(var r in c){j=c[r];if(id=j.id){if(!g[id]){j.presence=j.presence||"online";j.show=j.show?j.show:j.presence=="offline"?"unavailable":"available";g[id]={};e.push(g[id])}j.incomplete=!!j.incomplete;
if(n=J(g[id],j)){j=n.presence||"update";i[j]=i[j]||[];A(g[id],n);i[j].push(g[id])}}}for(var v in i)this.trigger(v,[i[v]]);this.options.active&&this.complete()}});(function(){E("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},{_init:function(){this.data=this.data||[];this.dataHash={};this.request=this.options.jsonp?T:F},get:function(c){return this.dataHash[c]},block:function(c){var e=this.dataHash[c];if(e&&!e.blocked){e.blocked=true;var g=[];D(this.dataHash,function(i,
j){j.blocked&&g.push(j.id)});this.trigger("block",[c,g])}},unblock:function(c){var e=this.dataHash[c];if(e&&e.blocked){e.blocked=false;var g=[];D(this.dataHash,function(i,j){j.blocked&&g.push(j.id)});this.trigger("unblock",[c,g])}},handle:function(c){var e=this,g=e.data,i=e.dataHash;D(c,function(j,n){var r=n.id;if(r){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(i[r])A(i[r],n);else{i[r]=n;g.push(n)}e.trigger("join",[i[r]])}})},addMember:function(c,e){var g=this;if(O(e))D(e,
function(v,o){g.addMember(c,o)});else{var i=g.dataHash[c];if(i){for(var j=i.members,n,r=j.length;r--;)if(j[r].id==e.id)n=j[r];if(!n){e.nick=e.nick;j.push(e);i.count=j.length;g.trigger("addMember",[c,e])}}}},removeMember:function(c,e){var g=this.dataHash[c];if(g){for(var i=g.members,j,n=i.length;n--;)if(i[n].id==e){j=i[n];i.splice(n,1);g.count--}j&&self.trigger("removeMember",[c,j])}},initMember:function(c){var e=this.dataHash[c];if(e&&!e.initMember){e.initMember=true;this.loadMember(c)}},loadMember:function(c){var e=
this,g=e.options;e.request({type:"get",async:true,cache:false,url:g.urls.member,dataType:"json",data:{ticket:g.ticket,id:c},success:function(i){e.addMember(c,i)}})},join:function(c){var e=this,g=e.options;e.request({cache:false,type:"post",async:true,url:g.urls.join,dataType:"json",data:{ticket:g.ticket,id:c,nick:g.user.nick},success:function(i){e.initMember(c);e.handle([i])}})},leave:function(c){var e=this.options,g=this.dataHash[c],i=e.user;if(g){g.initMember=false;this.request({cache:false,type:"post",
url:e.urls.leave,data:{ticket:e.ticket,id:c,nick:i.nick}});this.trigger("leave",[g])}},clear:function(){}})})();E("history",{urls:{load:"webim/history",clear:"webim/clear_history",download:"webim/download_history"}},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{};this.request=this.options.jsonp?T:F},get:function(c,e){return this.data[c][e]},unicast:function(c){return this.data.unicast[c]},multicast:function(c){return this.data.multicast[c]},
handle:function(c){var e=this.data,g={unicast:{},multicast:{}};c=aa(c);var i=c.length,j,n,r=this.options.userInfo.id;if(i){for(var v=0;v<i;v++){j=c[v];o=j.type;if((n=o=="unicast"?j.to==r?j.from:j.to:j.to)&&o){g[o][n]=g[o][n]||[];g[o][n].push(j)}}for(var o in g)for(n in g[o]){j=g[o][n];if(e[o][n]){e[o][n]=e[o][n].concat(j);this._triggerMsg(o,n,j)}else this.load(o,n)}}},_triggerMsg:function(c,e,g){this.trigger(c,[e,g])},clear:function(c,e){var g=this.options;this.data[c][e]=[];this.trigger("clear",
[c,e]);this.request({url:g.urls.clear,type:"post",cache:false,data:{type:c,id:e}})},download:function(c,e){var g=this.options.urls.download;(new Date).getTime();var i=u.createElement("iframe"),j=new Date,n=[];j={id:e,type:c,time:(new Date).getTime(),date:j.getFullYear()+"-"+(j.getMonth()+1)+"-"+j.getDate()};for(var r in j)n[n.length]=encodeURIComponent(r)+"="+encodeURIComponent(j[r]);g+=(/\?/.test(g)?"&":"?")+n.join("&");i.setAttribute("src",g);i.style.display="none";u.body.appendChild(i)},init:function(c,
e,g){if(O(g)){this.data[c][e]=g;this._triggerMsg(c,e,g)}},load:function(c,e){var g=this,i=g.options;g.data[c][e]=[];g.request({url:i.urls.load,async:true,cache:false,type:"get",dataType:"json",data:{type:c,id:e},success:function(j){g.init(c,e,j)}})}})})(window,document);
(function(s,u,V){function $(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function N(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function O(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType==1&&a!=b&&d.push(a);return d}function W(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function H(a,b){if(a)W(a,
b)||(a.className+=" "+b)}function J(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function aa(a,b,d){t(a,"mouseover",function(){H(this,b);d&&J(this,d)});t(a,"mouseout",function(){J(this,b);d&&H(this,d)})}function A(a,b,d){if(typeof d==="boolean")d?H(a,b):J(a,b);else W(a,b)?J(a,b):H(a,b)}function D(a){a&&a.style&&(a.style.display="block")}function B(a){a&&a.style&&(a.style.display="none")}function t(a,b,d){if(a.addEventListener)a.addEventListener(b,
d,false);else{a["e"+b+d]=d;a[b+d]=function(){return a["e"+b+d](s.event)};a.attachEvent("on"+b,a[b+d])}}function F(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function T(a){if(!a.target)a.target=a.srcElement||u;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function Y(){if(!e){e=true;if(g){for(var a,b=0;a=g[b++];)a();g=null}}}function ga(){if(!i){i=true;if(u.readyState==="complete")return Y();if(u.addEventListener)u.addEventListener("DOMContentLoaded",
function(){u.removeEventListener("DOMContentLoaded",arguments.callee,false);Y()},false);else if(u.attachEvent){u.attachEvent("onreadystatechange",function(){if(u.readyState==="complete"){u.detachEvent("onreadystatechange",arguments.callee);Y()}});u.documentElement.doScroll&&s==s.top&&function(){if(!e){try{u.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}Y()}}()}t(s,"load",Y)}}function Q(a){var b=new Date;b.setTime(a?parseFloat(a)+Q.timeSkew:(new Date).getTime());this.date=
b}function x(a,b,d){d=C({locale:x.locale},d);d=x.dictionary[d.locale];X(d)||(d={});a=d[a]===V?a:d[a];if(b){r=b;for(var f in b)a=a.replace(/\{\{(.*?)\}\}/g,v)}return a}function w(a,b){this.element=a;this.options=C({},w.defaults,b);this._init()}function da(a){a=a.getElementsByTagName("*");for(var b,d,f={},h=a.length-1;h>-1;h--){b=a[h];if((d=b.id)&&d.indexOf(":")==0)f[d.substring(1,d.length)]=b}return f}function E(a){var b=u.createElement("div");b.innerHTML=a;return b=b.firstChild}function I(a,b,d){function f(h,
k){this.id=P++;this.name=a;this.className="webim-"+a;this.options=C({},f.defaults,k);if(this.element=h||this.template&&E(this.template())||this.options.template&&E(o(this.options.template))){this.options.className&&H(this.element,this.options.className);this.$=da(this.element)}ba(this._init)&&this._init();ba(this._initEvents)&&this._initEvents()}f.defaults=b;C(f.prototype,ca,I.prototype,d);w[a]=f}function L(a,b){w.apps[a]=b}function U(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}
function ea(){u.selection&&(this.caretPos=u.selection.createRange())}var ia=webim.idsArray,ba=webim.isFunction,ha=webim.isArray,X=webim.isObject,fa=webim.trim,R=webim.makeArray,C=webim.extend,z=webim.each,M=webim.grep,ca=webim.objectExtend,c=webim.map,e=false,g=[],i=false;Q.timeSkew=0;Q.init=function(a){Q.timeSkew=(new Date).getTime()-parseFloat(a)};C(Q.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;
if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return x("dt:today");else if(a<864E5)return x("dt:yesterday")}return x("dt:monthdate",{month:x(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var j=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=
false},init:function(d){C(b,d);d=b.lib+"?_"+(new Date).getTime();d=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+d+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+d+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+d+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';
try{u.getElementById("webim-flashlib-c").innerHTML=d}catch(f){}},play:function(d){d=/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(d)?d:b[d];if(a)try{u.getElementById("webim-flashlib").playSound(d?d:"/sound/sound.mp3")}catch(f){}}}}(),n=function(){var a=false;t(s,"focus",function(){a=false});t(s,"blur",function(){a=true});var b=u.title,d=0,f=false;return function(h,k){if(a){if(l){clearInterval(l);d=0;f=false}var l=setInterval(function(){d++;f=!f;if(d==k||!a){clearInterval(l);
d=0;f=false}u.title=f?"["+h+"]"+b:b},1500)}}}(),r={},v=function(a,b){return r[b]||""};x.locale="zh-CN";x.dictionary={};x.store=function(a,b){var d=x.dictionary;X(d[a])||(d[a]={});C(d[a],b)};C(w.prototype,ca,{init:function(){var a=this,b=a.im,d=b.history,f=b.setting,h=a.layout,k=b.room;b.buddy.bind("online",function(l){h.updateChat("buddy",l)}).bind("offline",function(l){h.updateChat("buddy",l)}).bind("update",function(l){h.updateChat("buddy",l)});k.bind("addMember",function(l,m){var p=h.chat("room",
l);p&&p.addMember&&p.addMember(m.id,m.nick,m.id==b.data.user.id)}).bind("removeMember",function(l,m){var p=h.chat("room",l);p&&p.removeMember&&p.removeMember(m.id,m.nick)});b.bind("message",function(l){for(var m=false,p=l.length,q,K=b.data.user.id,S,Z,ja=0;ja<p;ja++){q=l[ja];S=q.id;type=q.type;(Z=h.chat(type,S))&&Z.status("");if(!Z){q.type==="unicast"?a.addChat(type,S,q.nick):a.addChat(type,S);Z=h.chat(type,S)}Z&&f.get("msg_auto_pop")&&!h.activeTabId&&h.focusChat(S);Z.window.notifyUser("information",
"+1");S=Z.window.pos;S==-1&&h.setNextMsgNum("+1");S==1&&h.setPrevMsgNum("+1");if(q.from!=K)m=true}if(m){a.trigger("newMessage");j.play("msg");n(x("new message"),5)}});b.bind("status",function(l){z(l,function(m,p){var q=b.data.user.id,K=p.from;if(!(q!=p.to&&q!=p.from))(q=h.chat("buddy",K))&&q.status(p.show)})});d.bind("unicast",function(l,m){var p=h.chat("unicast",l);p&&p.history.add(m)});d.bind("multicast",function(l,m){var p=h.chat("multicast",l);p&&p.history.add(m)});d.bind("clear",function(l,m){var p=
h.chat(l,m);p&&p.history.clear()})},render:function(){this.layout.render()},addApp:function(a,b){var d=w.apps[a];if(d)return this[a]=d.apply(this,[b])},addChat:function(a,b,d){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var f=this.layout,h=this.im.buddy,k=this.im.room;if(!f.chat(a,b)){if(a=="room")k=k.get(b);else(k=h.get(b))||h.update(b);f.addChat(a,b,this.addApp("chat",{type:a,user:this.im.data.user,info:k||{id:b,nick:d||b}}))}},_init:function(){this.im=new webim(null,this.options.imOptions);
this.addApp("layout",this.options.layoutOptions);this._initEvents();ba(this.init)&&this.init()},_initEvents:function(){this.im.bind("go",function(a){Q.init(a.server_time)})}});var o=function(){function a(f,h){return b&&b[h]!=V?b[h]:x(h)}var b=null,d=/\<\%\=(.*?)\%\>/ig;return function(f,h){if(!f)return"";b=h;return f.replace(d,a)}}(),y={add:function(a,b,d){a=w[a].prototype;for(var f in d){a.plugins[f]=a.plugins[f]||[];a.plugins[f].push([b,d[f]])}},call:function(a,b,d){if((b=a.plugins[b])&&a.element.parentNode)for(var f=
0;f<b.length;f++)a.options[b[f][0]]&&b[f][1].apply(a.element,d)}},P=1;C(I.prototype,{_init:function(){}});C(w,{version:"3.0.1",widget:I,app:L,plugin:y,i18n:x,date:Q,ready:function(a){ga();e?a():g.push(a)},createElement:E,defaults:{},apps:{}});webim.ui=w;I("window",{main:false,isMinimized:false,minimizable:true,maximizable:false,layoutUrl:"app:/test/air.window.html",iconUrl:"app:/images/logo128.png",closeable:true,count:0,template:'<div class="webim"><div id=":webim-window" class="webim-window ui-widget">                                            <div id=":window" class="webim-window-window webim-box">                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                    \t<a id=":resize" title="<%=resize%>" class="webim-window-resize" href="#resize"><em class="ui-icon ui-icon-grip-diagonal-se"><%=resize%></em></a>                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content webim-box webim-flex">                                                    </div>                                            </div>                                            </div></div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){return this.$.subHeader.appendChild(a)},_init:function(a,b){var d=this;b=d.options;var f=d.$;a=d.element;b.name&&H(a,"webim-"+b.name+"-window");if(s.runtime)if(b.main){d.window=s;d.__initEvents()}else{var h=air.Screen.mainScreen.visibleBounds;h=new air.Rectangle((h.width-480)/2,(h.height-480)/2,480,480);var k=new air.NativeWindowInitOptions;k.transparent=true;k.systemChrome=air.NativeWindowSystemChrome.NONE;var l=air.HTMLLoader.createRootWindow(true,
k,false,h);l.navigateInSystemBrowser=true;l.load(new air.URLRequest(d.options.layoutUrl));var m=false;t(l,air.Event.COMPLETE,function(){if(!m){m=true;d.window=l.window;d.__initEvents();l.window.document.body.appendChild(a)}})}else{H(a,"webim-browser");b.main||u.body.appendChild(a);d.__initEvents()}b.subHeader&&d.subHeader(b.subHeader);d.title(b.title,b.icon);!b.minimizable&&B(f.minimize);!b.maximizable&&B(f.maximize);!b.closeable&&B(f.close);b.count&&d.notifyUser("information",b.count)},notifyUser:function(a){a==
"information"&&this.isMinimized()},_count:function(){},title:function(a){this.$.headerTitle.innerHTML=a},_changeState:function(a){var b=this.element,d="webim-window-"+(a=="restore"?"normal":a);b&&(b.className=b.className.replace(RegExp("(^|\\s+)("+"webim-window-normal webim-window-maximize webim-window-minimize".split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+d);this.trigger("displayStateChange",[a])},maximize:function(){var a=this.window.nativeWindow;if(this.isMaximized())this.restore();else{a.maximize();
this._changeState("maximize")}},restore:function(){var a=this.window.nativeWindow;a&&a.restore();W(this.element,"webim-window-normal")||this._changeState("restore")},minimize:function(){var a=this.window.nativeWindow;if(!this.isMinimized()){a.minimize();this._changeState("minimize")}},resize:function(){},close:function(){if(this.options.main)this.window.nativeWindow.visible=false;else this.window.nativeWindow.close()},__initEvents:function(){var a=this,b=a.$,d=function(k){if(k){k.stopPropagation&&
k.stopPropagation();k.cancelBubble=true}F(k)};z(O(b.actions.firstChild),function(k,l){aa(l,"ui-state-hover")});z(["minimize","maximize","close","resize"],function(k,l){t(b[l],"click",function(m){this.disabled||a[l]();d(m)});t(b[l],"mousedown",d)});if(s.runtime){var f=a.window.nativeWindow;t(a.window.document,"keydown",function(){});t(b.headerTitle,"dblclick",function(){a._os.mac?a.minimize():a.maximize()});t(b.header,"mousedown",function(){if(a.isMaximized())return false;f.startMove()});t(b.resize,
"mousedown",function(){f.startResize(air.NativeWindowResize.BOTTOM_RIGHT)});if(a.options.main){t(air.NativeApplication.nativeApplication,air.InvokeEvent.INVOKE,function(){!f.visible&&(f.visible=true)});var h=new air.Loader;t(h.contentLoaderInfo,air.Event.COMPLETE,function(k){air.NativeApplication.nativeApplication.icon.bitmaps=new runtime.Array(k.target.content.bitmapData)});h.load(new air.URLRequest(a.options.iconUrl))}t(f,air.NativeWindowBoundsEvent.RESIZE,function(k){a.trigger("resize",k)});t(f,
air.NativeWindowBoundsEvent.MOVE,function(k){a.trigger("move",k)});t(f,air.Event.ACTIVATE,function(k){a.trigger("activate",k)});t(f,air.Event.DEACTIVATE,function(k){a.trigger("deactivate",k)});t(f,air.Event.CLOSE,function(k){a.trigger("close",k)})}},activate:function(){return this.window&&this.window.nativeWindow.activate()},isActive:function(){return this.window&&this.window.nativeWindow.active},isMaximized:function(){return this.window&&this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MAXIMIZED},
isMinimized:function(){return this.window&&this.window.nativeWindow.displayState==air.NativeWindowDisplayState.MINIMIZED},_os:function(){var a=s.runtime&&air.Capabilities.os;return{mac:/Mac/i.test(a),win:/Windows/i.test(a),linux:/Linux/i.test(a)}}()});L("layout",function(a){a=a||{};var b=this.im;layoutUI=new w.layout(a.layout,a.layoutOptions);this.addApp("login",C({container:layoutUI.element},a.loginOptions));this.addApp("user",C({container:layoutUI.window.$.subHeader},a.userOptions));b.bind("go",
function(){layoutUI.showContent()});layoutUI.window.subHeader(layoutUI.tabs.element);return layoutUI});I("layout",{template:'<div id=":layout" class="webim-layout webim-flex webim-box">\t\t<div id=":widgets" class="webim-widgets webim-flex webim-box webim-hide"></div>\t\t<div id=":shortcut" class="webim-shortcut ui-widget-header webim-hide"></div>\t</div>'},{_init:function(){C(this,{window:new w.window(null,{main:true,name:"layout",title:"webim",maximizable:true,icon:""}),widgets:{},chats:{},tabs:new w.tabs(null,
{panel:this.$.widgets}),chatWindows:{}});H(this.tabs.element,"webim-hide");this.window.html(this.element)},_initEvents:function(){},render:function(){u.body.appendChild(this.window.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var d=b.container,f=C(b,{main:false,closeable:false,subHeader:a.header}),h=a.element;this.widgets[a.name]=a;a.widget_title=b.title;if(d=="window"){d=new w.window(null,f);d.html(h);a.container=d}else if(d=="tab"){this.tabs.add(a.element,b.title,
b.icon);this.tabs.select(b.title)}},showWidget:function(a){this.tabs.select(this.widgets[a].widget_title)},focusChat:function(a,b){b=U(a,b);var d=this.chatWindows[b],f=this.chats[b];d&&d.activate();f&&f.focus()},chat:function(a,b){return this.chats[U(a,b)]},updateChat:function(a,b){b=R(b);for(var d,f=b.length,h,k=0;k<f;k++){d=b[k];(h=this.chats[U(a,d.id)])&&h.update(d)}},updateAllChat:function(){z(this.chats,function(a,b){b.update()})},addChat:function(a,b,d){var f=this,h=f.chats;b=U(a,b);if(!h[b]){a=
f.chatWindows[b]=(new w.window(null,{main:false,name:"chat",title:"webim",maximizable:true,icon:""})).bind("close",function(){delete f.chatWindows[b];delete f.chats[b]});d.setWindow(a);h[b]=d}},removeChat:function(a,b){var d=this.chatWindows[U(a,b)];d&&d.close()},removeAllChat:function(){z(this.chatWindows,function(a,b){b.close()})},showContent:function(){J(this.$.widgets,"webim-hide");J(this.tabs.element,"webim-hide");J(this.$.shortcut,"webim-hide")}});I("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){y.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=R(a);var b=a.length,d=[];if(b){for(var f=0;f<b;f++)d.push(this._renderMsg(a[f]));this.$.content.innerHTML+=d.join("");this.trigger("update")}},_renderMsg:function(a){a=C({},a);y.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,d=a.to,f=a.timestamp,h=a.body,k=true,l=this._lastLogItem,m=[],p;p=a.nick;if(l&&l.to==d&&l.from==b&&f-l.timestamp<6E4)k=false;
if(k){this._lastLogItem=a;a=new Q(f);m.push('<h4><span class="webim-gray">');m.push(a.getDay(true));m.push(" ");m.push(a.getTime());m.push("</span>");m.push(p);m.push('</h4><hr class="webim-line ui-state-default" />')}m.push("<p>");m.push(h);m.push("</p>");return m.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,d=new Date,f=new Date,h=[];d.setTime(a);b&&f.setTime(b.timestamp);if(!b||d.getDate()!=f.getDate()||d.getMonth()!=f.getMonth()){h.push("<h5>");h.push((new Q(a)).getDay(true));
h.push("</h5>")}return h.join("")},ui:function(a){return C({element:this.element,$:this.$},a)},plugins:{}});var G=function(){function a(f,h){return'<a href="'+(h=="www."?"http://"+f:f)+'"'+d+">"+f+"</a>"}function b(f,h){d+=" "+f+'="'+h+'"'}var d;return function(f,h){d="";h&&X(h)&&z(h,b);return f.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();w.history.defaults.parseMsg=true;y.add("history","parseMsg",{render:function(a,b){var d=b.msg.body;d=$(d);d=G(d,{target:"_blank"});b.msg.body=d}});w.history.defaults.emot=
true;y.add("history","emot",{render:function(a,b){b.msg.body=w.emot.parse(b.msg.body)}});I("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;z(b.firstChild.childNodes,function(d,f){t(f,"click",function(){J(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');z(a,function(d,f){var h=f.src,k=f.t?f.t:
f.q[0];b.push('<li><img src="');b.push(h);b.push('" title="');b.push(k);b.push('" alt="');b.push(f.q[0]);b.push('" rel="');b.push(f.q[0]);b.push('" /></li>')});b.push("</ul>");return o(this.options.template,{emots:b.join("")})},toggle:function(){A(this.element,"webim-emot-show")}});C(w.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",
q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},
{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,d=b._q={};a=C({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var f=a.dir+"/";z(b.emots,function(h,k){if(k&&k.src)k.src=f+k.src;k&&k.q&&z(k.q,function(l,m){d[m]=h})})},parse:function(a){var b=webim.ui.emot._q,d=webim.ui.emot.emots;b&&z(b,function(f,h){var k=d[h],l=k.src,m=k.t?k.t:k.q[0],p=[];p.push('<img src="');p.push(l);p.push('" title="');p.push(m);p.push('" alt="');p.push(k.q[0]);p.push('" />');f=
$(f);f=f.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(f,"g"),p.join(""))});return a}});L("chat",function(a){a=a||{};var b=this.im,d=b.buddy,f=b.room,h=b.history,k=a.info,l=k.id;if(a.type=="room"){k.presence="online";var m=h.get("multicast",l);m||h.load("multicast",l);C(a,{history:m,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"});var p=new w.chat(null,a);p.bind("sendMsg",function(q){b.sendMsg(q);h.handle(q)}).bind("downloadHistory",
function(q){h.download("multicast",q.id)}).bind("select",function(q){q.presence="online";d.presence(q);self.addChat("buddy",q.id,q.nick);layout.focusChat("buddy",q.id)}).bind("block",function(q){f.block(q.id)}).bind("unblock",function(q){f.unblock(q.id)}).bind("destroy",function(){p.options.info.blocked&&f.leave(l)});setTimeout(function(){p.options.info.blocked?f.join(l):f.initMember(l)},500);ha(k.members)&&z(k.members,function(q,K){p.addMember(K.id,K.nick,K.id==b.data.user.id)})}else{(m=h.get("unicast",
l))||h.load("unicast",l);C(a,{history:m,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"});p=new w.chat(null,a);p.bind("sendMsg",function(q){b.sendMsg(q);h.handle(q)}).bind("sendStatus",function(q){b.sendStatus(q)}).bind("clearHistory",function(q){h.clear("unicast",q.id)}).bind("downloadHistory",function(q){h.download("unicast",q.id)})}return p});I("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat webim-box webim-flex"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content webim-flex">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.options,b=a.window,d=this.history=new w.history(null,{user:a.user,info:a.info});this.$.content.insertBefore(d.element,this.$.content.firstChild);this.header=E(o(a.tpl_header));C(this.$,da(this.header));b&&this.setWindow(b);a.simple&&B(this.header);this.update(a.info);d.add(a.history);y.call(this,"init",[null,this.ui()]);this._adjustContent()},setWindow:function(a){this.window=a;a.subHeader(this.header);a.html(this.element);a.title(this.options.info.nick);this._bindWindow()},
update:function(a){if(a){this.option("info",a);this.history.option("info",a);this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(x("buddy offline notice",{name:this.options.info.nick}));else this.notice(x("user offline notice"));y.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;s.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var d=this,f=d.$.notice,h=d._noticeTime;
h&&clearTimeout(h);if(a)if(b){f.innerHTML=a;D(f);setTimeout(function(){if(d._noticeTxt)f.innerHTML=d._noticeTxt;else B(f,500)},b)}else{d._noticeTxt=a;f.innerHTML=a;D(f)}else{d._noticeTxt=null;B(f)}},_adjustContent:function(){var a=this.$.content;if(a.scrollHeight-a.scrollTop<200)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b){if(b!="minimize"){s.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",
function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var d=a.height();d>32&&d<100&&a.height(d+b)}},_sendMsg:function(a){var b=this.options,d=b.info;a={type:b.msgType,to:d.id,from:b.user.id,nick:b.user.nick,offline:d.presence!="online",timestamp:(new Date).getTime(),body:a};y.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=T(a),d=
b.value;if(fa(d).length){this._sendMsg(d);b.value="";F(a)}}else this._typing()},_onFocusInput:function(a){var b=this;T(a);(s.getSelection?s.getSelection().toString():u.selection?u.selection.createRange().text:"")||s.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,d=x("input notice"),f=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(x("clear history notice"),3E3)});t(f,"keyup",function(){ea.call(this)});t(f,"click",
ea);t(f,"select",ea);t(f,"focus",function(){J(this,"webim-gray");if(this.value==d)this.value=""});t(f,"blur",function(){if(this.value==""){H(this,"webim-gray");this.value=d}});t(f,"keypress",function(h){a._inputkeypress(h)});t(b.content,"click",function(h){a._onFocusInput(h)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",
a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=N(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var d=this.$.input;d.focus();if(b){a||(a="");if(d.setSelectionRange){var f=d.value,h=d.selectionStart,k=d.selectionEnd,l=f.substring(0,h);f=f.substring(k);k=a.length;d.value=l+a+f;d.setSelectionRange(h+k,h+k)}else if(u.selection)if(h=d.caretPos){h.text=a;h.collapse();h.select()}else d.value+=a;else d.value+=a}else d.value=a},_statusText:"",sendStatus:function(a){if(!(!a||
a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",{to:this.options.info.id,show:a})}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=s.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,d=this.options.info.nick,f="";f=a=="clear"?"":d+x(a);b.innerHTML=f;this._adjustContent();this._setST&&clearTimeout(this._setST);
if(f!="")this._setST=s.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return C({self:this,$:this.$,history:this.history},a)},plugins:{}});w.chat.defaults.emot=true;y.add("chat","emot",{init:function(a,b){var d=b.self,f=new w.emot;f.bind("select",function(k){d.focus();d.insert(k,true)});var h=E(o('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));t(h,"click",function(k){F(k);f.toggle()});b.$.toolContent.appendChild(f.element);
b.$.tools.appendChild(h)},send:function(){}});w.chat.defaults.clearHistory=true;y.add("chat","clearHistory",{init:function(a,b){var d=b.self,f=E(o('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));t(f,"click",function(h){F(h);d.trigger("clearHistory",[d.options.info])});b.$.tools.appendChild(f)}});w.chat.defaults.block=true;y.add("chat","block",{init:function(a,b){var d=b.self,f=d.options.info.blocked,h=d.options.info.nick,k=E('<a href="#chat-block" style="display:'+
(f?"none":"")+'" title="'+x("block group",{name:h})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),l=E('<a href="#chat-block" style="display:'+(f?"":"none")+'" title="'+x("unblock group",{name:h})+'"><em class="webim-icon webim-icon-block"></em></a>');t(k,"click",function(m){F(m);B(k);D(l);d.trigger("block",[d.options.info])});t(l,"click",function(m){F(m);B(l);D(k);d.trigger("unblock",[d.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(l)}});w.chat.defaults.member=true;C(w.chat.prototype,
{addMember:function(a,b,d){var f=this,h=f.memberLi;if(!h[a]){var k=E('<li><a class="'+(d?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");t(k.firstChild,"click",function(l){F(l);d||f.trigger("select",[{id:a,nick:b}])});h[a]=k;f.$.member.appendChild(k);f.$.memberCount.innerHTML=parseInt(f.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-
1}}});y.add("chat","member",{init:function(a,b){var d=b.$;b.self.memberLi={};var f=E(o('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),h=da(f);d.member=h.ul;d.memberCount=h.memberCount;d.content.parentNode.insertBefore(f,d.content)}});w.chat.defaults.downloadHistory=true;y.add("chat","downloadHistory",
{init:function(a,b){var d=b.self,f=E(o('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));t(f,"click",function(h){F(h);d.trigger("downloadHistory",[d.options.info])});b.$.tools.appendChild(f)}});L("setting",{init:function(a){var b=this.im.setting,d=this.layout,f=this.setting=new w.setting(null,a);d.addWidget(f,{title:x("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(h,
k){typeof k!="object"&&f.check_tag(h,k)});f.bind("change",function(h,k){b.set(h,k)})},stop:function(){}});I("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],d=a.options.data;d&&z(d,function(f,h){h&&typeof h!=
"boolean"||b.push(a._check_tpl(f,h))});return o(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,d=a.$;b&&z(b,function(f){d[f]&&a._check_event(d[f])})},_check_tpl:function(a,b){return o(this.options.tpl_check,{label:x(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;t(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var d=this;if(X(a))z(a,function(k,l){d.check_tag(k,l)});else{var f=
d.$,h=f[a];if(!(b&&typeof b!="boolean"))if(h)h.firstChild.checked=b;else{h=f[a]=E(d._check_tpl(a,b));d._check_event(h);f.ul.appendChild(h)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});L("user",function(a){a=a||{};var b=this.im,d=new w.user;B(d.element);a.container&&a.container.appendChild(d.element);d.bind("online",function(f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",function(f){b.sendPresence(f)});d.update(b.data.user);b.bind("go",function(){D(d.element);
d.update(b.data.user)}).bind("stop",function(){d.show("unavailable")});return d});I("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,d=b.userShowList;t(b.userShowTrigger,"click",function(f){d.style.display=="block"?B(d):D(d);F(f)});z(O(d.firstChild),function(f,h){t(h,"click",function(k){a._set(this.href.split("#")[1]);B(d);F(k)})})},update:function(a){var b=a.show||"unavailable",d=this.$;this.options.info=a;d.userStatus.innerHTML=N(a.status)||"&nbsp;";d.userNick.innerHTML=a.nick||"";d.userPic.setAttribute("href",a.url);d.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?
a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)d.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=x(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,status:b.status}])}else a!=
"unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});L("login",function(a){a=a||{};var b=this.im,d=new w.login(null,a);a.container&&a.container.appendChild(d.element);d.bind("login",function(f){b.online(f)});b.bind("go",function(){d.hide()}).bind("stop",function(f,h){f=="online"&&d.showError(h)});return d});I("login",{questions:null,notice:"",template:'<div>  \t\t<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?z(a,function(d,f){var h=u.createElement("option");h.value=f[0];h.innerHTML=f[1];b.question.appendChild(h)}):B(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;aa(b.submit,"ui-state-hover");t(b.form,"submit",function(d){F(d);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){B(this.element)},show:function(){D(this.element)},
hideError:function(){B(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=x(a);D(b)},destroy:function(){}});L("buddy",function(a){a=a||{};var b=this,d=b.im,f=d.buddy,h=b.layout,k=new w.buddy(null,C({title:x("buddy")},a));h.addWidget(k,{container:"tab",title:x("buddy"),icon:"buddy"});k.bind("select",function(q){b.addChat("buddy",q.id);b.layout.focusChat("buddy",q.id)});var l=function(q){return X(q)?q.id:q},m=function(q){return q.show!="invisible"&&q.presence=="online"},p=function(q){return q.show==
"invisible"};f.bind("online",function(q){k.add(M(q,m))});f.bind("offline",function(q){k.remove(c(q,l))});f.bind("update",function(q){k.add(M(q,m));k.update(M(q,m));k.remove(c(M(q,p),l))});k.offline();d.bind("ready",function(){k.online()}).bind("go",function(){k.titleCount()}).bind("stop",function(){k.offline()});return k});I("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&H(this.element,"webim-buddy-hidegroup");a.simple&&H(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,d=b.search,f=b.searchInput,h=x("search buddy");t(d.firstChild,"click",function(){f.focus()});f.value=h;t(f,"focus",function(){H(d,"ui-state-active");if(this.value==h)this.value=""});t(f,"blur",function(){J(d,"ui-state-active");if(this.value=="")this.value=h});t(f,"keyup",function(){var k=
this.value;z(a.li,function(l,m){k&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?B(m):D(m)})})},titleCount:function(){var a=this.size,b=this.window,d=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?B(d):D(d);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){A(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+x(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");B(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();B(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var d=b.show?b.show:"available";a.className="webim-icon webim-icon-"+d;a.setAttribute("title",
x(d));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=N(b.status)||"&nbsp;";return a},_addOne:function(a,b){var d=this,f=d.li,h=a.id,k=d.$.ul;if(!f[h]){d.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=N(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=x(a.show);a.pic_url=a.pic_url||"";f=f[h]=E(o(d.options.tpl_li,
a));t(f.firstChild,"click",function(p){F(p);d.trigger("select",[a]);this.blur()});var l=d.groups,m=x(a.group||"friend");l=l[m];if(!l){l=E(o(d.options.tpl_group));B(l);if(m==x("stranger"))b=true;b?k.appendChild(l):k.insertBefore(l,k.firstChild);l={name:m,el:l,count:0,title:l.firstChild,li:l.lastChild};d.groups[m]=l}l.count==0&&D(l.el);d.li_group[h]=l;l.li.appendChild(f);l.count++;l.title.innerHTML=m+"("+l.count+")"}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=
R(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=R(a);for(var d=0;d<a.length;d++)this._addOne(a[d],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a);this.titleCount()},remove:function(a){var b,d,f=this.li,h,k=this.li_group;a=ia(a);for(var l=0;l<a.length;l++){b=a[l];if(d=f[b]){this.size--;if(h=k[b]){h.count--;h.count==0&&B(h.el);h.title.innerHTML=h.name+"("+h.count+")"}d&&d.parentNode&&d.parentNode.removeChild(d);delete f[b]}}this.titleCount()},
select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});L("room",function(){function a(m){var p=m.nick;m=C({},m,{group:"group",nick:p+"("+(parseInt(m.count)+"/"+parseInt(m.all_count))+")"});k.updateChat(m);m.blocked&&(m.nick=p+"("+x("blocked")+")");l.li[m.id]?l.update(m):l.add(m)}var b=this,d=b.im,f=d.room,h=d.setting,k=b.layout,l=b.room=(new webim.ui.room(null)).bind("select",function(m){b.addChat("room",m.id);b.layout.focusChat("room",m.id)});k.addWidget(l,{container:"tab",
title:x("room"),icon:"room"});d.setting.bind("update",function(m,p){m=="buddy_sticky"&&l.window.option("sticky",p)});f.bind("join",function(m){a(m)}).bind("leave",function(){}).bind("block",function(m,p){h.set("blocked_rooms",p);a(f.get(m));f.leave(m)}).bind("unblock",function(m,p){h.set("blocked_rooms",p);a(f.get(m));f.join(m)}).bind("addMember",function(m){a(f.get(m))}).bind("removeMember",function(m){a(f.get(m))})});I("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;D(this.$.empty)},_initEvents:function(){var a=this,b=a.$,d=b.search,f=b.searchInput,h=x("search room");t(d.firstChild,"click",function(){f.focus()});f.value=h;t(f,"focus",function(){H(d,
"ui-state-active");if(this.value==h)this.value=""});t(f,"blur",function(){J(d,"ui-state-active");if(this.value=="")this.value=h});t(f,"keyup",function(){var k=this.value;z(a.li,function(l,m){k&&(m.text||m.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?B(m):D(m)})})},scroll:function(a){A(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,d=b.li,f=a.id,h=b.$.ul;b.size++;if(!d[f]){if(!a.default_pic_url)a.default_pic_url="";d=d[f]=E(o(b.options.tpl_li,a));t(d.firstChild,"click",function(k){F(k);b.trigger("select",[a]);this.blur()});h.appendChild(d)}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=R(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){B(this.$.empty);a=R(a);for(var b=
0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a)},remove:function(a){var b,d,f=this.li;a=ia(a);for(var h=0;h<a.length;h++){b=a[h];if(d=f[b]){d&&d.parentNode&&d.parentNode.removeChild(d);delete f[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});L("menu",{init:function(a){var b=this.layout;a=this.menu=new w.menu(null,a);b.addWidget(a,{title:x("menu"),icon:"home",
sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")}});I("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&B(this.$.empty)},template:function(){var a=this,b=[],d=a.options.data;d&&z(d,function(f,h){b.push(a._li_tpl(h))});
return o(a.options.template,{list:b.join("")})},_li_tpl:function(a){return o(this.options.tpl_li,{title:x(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(ha(a))z(a,function(f,h){b.add(h)});else{var d=b.$;B(d.empty);d.ul.appendChild(E(b._li_tpl(a)))}},destroy:function(){}});I("tabs",{template:'<div class="webim-tabs">\t\t<ul id=":nav" class="webim-tabs-nav ui-helper-clearfix"></ul>\t\t\t</div>',
panel:false},{_init:function(){this.panels={};this.navs={}},add:function(a,b){var d=this.$.nav,f=this.navs[b]=E('<li class="ui-corner-top ui-state-default"><a href="#">'+b+"</a></li>");H(a=a?a.nodeType?a:u.getElementById(a):null,"ui-helper-hidden-accessible");this.panels[b]=a;d.appendChild(f);this.options.panel&&this.options.panel.appendChild(a);this._tabEvent(f,b)},select:function(a){if(a=this.navs[a]){a=O(a.firstChild)[0];if(u.createEvent){var b=u.createEvent("HTMLEvents");b.initEvent("click",true,
true);a.dispatchEvent(b)}a.fireEvent&&a.fireEvent("onclick")}},_tabEvent:function(a,b){var d=this,f=O(a.firstChild)[0];t(f,"click",function(h){z(d.panels,function(k,l){H(l,"ui-helper-hidden-accessible")});z(d.navs,function(k,l){J(l,"ui-state-active")});J(d.panels[b],"ui-helper-hidden-accessible");H(d.navs[b],"ui-state-active");F(h)})}})})(window,document);
